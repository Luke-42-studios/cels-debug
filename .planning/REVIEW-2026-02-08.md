# Performance Validation Review — 2026-02-08

Review findings from full CELS project audit. Context for cels-debug v0.2 planning.

## Context

Performance validation (PERF-01 through PERF-04) moved from main CELS roadmap to this satellite app.
CELS core v0.2 Phase 5 (Smart Reconciliation) is complete. Phase 4 left known benchmark regressions.

## PERF Requirements (from CELS REQUIREMENTS.md)

- **PERF-01**: Benchmark comparison report — v0.2 vs v0.1 baseline for all 8 benchmarks
- **PERF-02**: Arena utilization metrics — peak usage, watermark tracking per arena
- **PERF-03**: Reconciliation skip rate — % of compositions that skip factory via prop memoization
- **PERF-04**: All 67+ tests pass with new architecture (zero regression)

## Current Baseline (v0.1 — main branch)

| Benchmark | Wall NS/op | Ops/Sec | Bytes/Entity |
|-----------|-----------|---------|--------------|
| entity_create_1000 | 1.11μs | ~900K | 0 |
| entity_create_destroy_1000 | 0.78μs | ~1.3M | 0 |
| composition_create_100 | 2.69μs | ~370K | 4KB |
| state_propagation | 7.11μs | ~140K | 0 |
| lifecycle_evaluation | 0.23μs | ~4.3M | 0 |
| component_register_100 | 7.9μs | ~126K | 0 |
| memory_entity_footprint | 10.01μs | ~100K | 56 bytes |
| recomposition_10_roots | 1.42μs | ~700K | 0 |

## Known Regressions (Phase 4 — SparseSet Migration)

| Benchmark | Regression | Severity | Likely Cause |
|-----------|------------|----------|--------------|
| state_propagation | **+73%** | Investigate | SparseSet iteration or dirty queue sort+dedup |
| lifecycle_evaluation | -8% | Acceptable | Lifecycle refactoring overhead |
| recomposition_10_roots | -3% | Acceptable | Recomposition changes |

**state_propagation +73% should be investigated before more code changes land.**

## Phase 5 Optimizations (Not Yet Benchmarked)

These shipped but have no benchmark numbers yet:

| Optimization | Expected Impact |
|--------------|----------------|
| Prop memoization (RECON-02) | Orders of magnitude for stable UIs — entire subtrees skipped |
| Children snapshot (RECON-03) | O(K²) → O(K) child lookups |
| Factory pointer identity (RECON-01) | String compare → pointer compare on hot path |
| Mark-and-sweep (RECON-04) | Correctness fix — handles arbitrary child mutations |
| Trampoline thinning (RECON-07) | 2 fewer memory writes per system call in release builds |

## Identified Bottlenecks Not Covered by Existing Plans

1. **memcmp prop memoization breaks for pointer-based props**
   - `const char* text` compares pointer value, not string content
   - Developers think memoization works but it silently doesn't
   - Need: documentation at minimum, `CEL_PropEqual` override mechanism ideally

2. **O(K) key scan in BeginEntity**
   - Acceptable for K < 20, but no per-frame key→index hashmap for larger lists
   - Future: arena-allocated hashmap per recomposition

3. **State propagation redundancy**
   - Multiple watchers of same state trigger redundant dirty queue entries
   - Dirty queue dedup helps but doesn't eliminate dependency-level redundancy

4. **flecs child iteration order instability**
   - Mitigated by CEL_Key but position-based matching still vulnerable
   - Future: per-frame child order cache if flecs can't guarantee stability

## Recommended Actions

### Immediate (before CELS Phase 6)
1. Run all 8 benchmarks on v2 branch to get post-Phase-5 numbers
2. Investigate state_propagation +73% regression (profile SparseSet vs unordered_map iteration)
3. Add benchmark for prop memoization skip rate (new benchmark: `recomposition_memoized`)

### Phase 6+ Integration
4. Add CEL_Remember to memory_entity_footprint benchmark
5. Add benchmark for CEL_Key keyed list reordering

### cels-debug v0.2 Features
6. Performance tab: display arena utilization (peak, watermark per frame)
7. Performance tab: display reconciliation skip rate
8. Performance tab: display dirty queue depth per frame
