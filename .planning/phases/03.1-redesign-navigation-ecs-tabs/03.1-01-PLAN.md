---
phase: 03.1-redesign-navigation-ecs-tabs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cels-debug/src/tabs/tab_ecs.h
  - cels-debug/src/tabs/tab_ecs.c
  - cels-debug/src/tab_system.h
  - cels-debug/src/tab_system.c
  - cels-debug/src/main.c
  - cels-debug/src/tui.c
  - cels-debug/CMakeLists.txt
autonomous: false

must_haves:
  truths:
    - "Top-level tabs are: Overview, ECS, Performance, State (4 tabs, not 5+)"
    - "ECS tab shows CELS-C tree view with 5 collapsible section headers"
    - "Selecting a component type entity shows entities-with-component in the inspector"
    - "Selecting a non-component entity shows its component values in the inspector"
    - "Section headers are navigable, Enter toggles collapse, all start collapsed"
    - "First letter of each section name is bold (already implemented in tree_view.c)"
    - "Arrow keys / j/k / Enter navigation works through headers and entity items"
  artifacts:
    - path: "cels-debug/src/tabs/tab_ecs.h"
      provides: "ECS tab vtable function declarations"
      exports: ["tab_ecs_init", "tab_ecs_fini", "tab_ecs_draw", "tab_ecs_input"]
    - path: "cels-debug/src/tabs/tab_ecs.c"
      provides: "Merged ECS tab: classification, tree view, context-sensitive inspector"
      min_lines: 400
    - path: "cels-debug/src/tab_system.h"
      provides: "TAB_COUNT 4"
      contains: "TAB_COUNT 4"
    - path: "cels-debug/src/tab_system.c"
      provides: "4-entry tab_defs array with ECS tab"
      contains: "tab_ecs_init"
  key_links:
    - from: "cels-debug/src/tab_system.c"
      to: "cels-debug/src/tabs/tab_ecs.h"
      via: "include and vtable function pointers"
      pattern: 'include.*tab_ecs\.h'
    - from: "cels-debug/src/tabs/tab_ecs.c"
      to: "tree_view_render"
      via: "tree view rendering in draw function"
      pattern: "tree_view_render"
    - from: "cels-debug/src/tabs/tab_ecs.c"
      to: "entity_class == ENTITY_CLASS_COMPONENT"
      via: "context-sensitive inspector branch"
      pattern: "ENTITY_CLASS_COMPONENT"
    - from: "cels-debug/src/main.c"
      to: "TAB_COUNT"
      via: "key range check uses TAB_COUNT"
      pattern: "0.*TAB_COUNT"
---

<objective>
Restructure the debugger from 5 tabs (Overview, Entities, Systems, Performance, State) to 4 tabs (Overview, ECS, Performance, State), merging the entity tree and component browsing into a unified ECS tab with a context-sensitive inspector panel.

Purpose: The CELS-C paradigm (Compositions, Entities, Lifecycles, Systems, Components) should be browsable from a single ECS tab with collapsible sections, not scattered across separate tabs. This makes the debugger's information architecture match the framework's mental model.

Output: New tab_ecs.h/c replacing tab_entities + tab_components, updated wiring in 5 files, 4-tab layout working end to end.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@cels-debug/.planning/PROJECT.md
@cels-debug/.planning/ROADMAP.md
@cels-debug/.planning/STATE.md
@cels-debug/.planning/phases/03.1-redesign-navigation-ecs-tabs/03.1-RESEARCH.md

@cels-debug/src/tabs/tab_entities.h
@cels-debug/src/tabs/tab_entities.c
@cels-debug/src/tabs/tab_components.h
@cels-debug/src/tabs/tab_components.c
@cels-debug/src/tab_system.h
@cels-debug/src/tab_system.c
@cels-debug/src/main.c
@cels-debug/src/tui.h
@cels-debug/src/tui.c
@cels-debug/src/tree_view.h
@cels-debug/src/data_model.h
@cels-debug/src/split_panel.h
@cels-debug/src/scroll.h
@cels-debug/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tab_ecs.h/c with merged entity+component logic and context-sensitive inspector</name>
  <files>
    cels-debug/src/tabs/tab_ecs.h
    cels-debug/src/tabs/tab_ecs.c
  </files>
  <action>
**tab_ecs.h** -- Follow the exact same pattern as tab_entities.h:
- Include guard `CELS_DEBUG_TAB_ECS_H`
- Include `"../tab_system.h"`
- Declare 4 functions: `tab_ecs_init`, `tab_ecs_fini`, `tab_ecs_draw`, `tab_ecs_input`
- Same signatures as tab_entities (tab_t*, WINDOW*, void* app_state)

**tab_ecs.c** -- Merge tab_entities.c and tab_components.c into a unified ECS tab. This is 90% reorganization of existing code. Specifically:

1. **Copy verbatim from tab_entities.c:**
   - `#define _POSIX_C_SOURCE 200809L` at top
   - All includes (tab_ecs.h instead of tab_entities.h, plus data_model.h for component_registry access)
   - `entities_state_t` struct (rename to `ecs_state_t`)
   - All classification functions: `has_tag()`, `has_component_component()`, `extract_pipeline_phase()`, `name_is_lifecycle()`, `classify_node()`, `propagate_class()`, `classify_all_entities()`
   - Inspector helpers: `count_inspector_rows()`, `ensure_comp_expanded()`, `count_groups()`, `cursor_to_group_index()`
   - `sync_selected_path()` helper
   - `tab_ecs_init()` (identical to tab_entities_init)
   - `tab_ecs_fini()` (identical to tab_entities_fini)

2. **Add new function from tab_components.c logic -- `annotate_component_entities()`:**
   - After `classify_all_entities()` is called in the draw function, call `annotate_component_entities(state->entity_list, state->component_registry)`
   - This function iterates all roots, finds nodes with `entity_class == ENTITY_CLASS_COMPONENT`, cross-references with component_registry by name, and sets `class_detail` to a string like "15 entities, 8B" (with size) or "15 entities" (without size)
   - See Research Example 3 for the exact implementation

3. **Modify tab_ecs_draw() -- context-sensitive inspector (RIGHT PANEL ONLY):**
   The left panel (tree view) is identical to tab_entities_draw. The right panel changes:

   After getting `entity_node_t *sel = tree_view_selected(&es->tree)`, branch on entity class:

   **Branch A: sel->entity_class == ENTITY_CLASS_COMPONENT** (component type selected from Components section)
   - Render a "Entities with <component_name>" header
   - Filter entities from `state->entity_list` that have the selected component name in their `component_names[]` array (same logic as tab_components.c lines 157-176)
   - Render matching entities as a scrollable list with name and path (same rendering as tab_components.c lines 183-228)
   - Use `es->inspector_scroll` for this list's scrolling
   - This replaces the entity_detail rendering for component-type selections

   **Branch B: sel exists but is NOT ENTITY_CLASS_COMPONENT** (entity from any other section)
   - Identical to current tab_entities_draw right panel: show entity_detail with components/tags/pairs

   **Branch C: sel is NULL** (section header selected)
   - Show "Select an entity" message (same as current)

   **IMPORTANT:** The split_panel_draw_borders call should use "ECS" and "Inspector" as panel titles.

4. **Modify tab_ecs_input() -- nearly identical to tab_entities_input:**
   - Left panel: identical (tree navigation with j/k/Enter/f)
   - Right panel when a COMPONENT entity is selected: scroll through the entities-with-component list (just j/k/PgUp/PgDn on inspector_scroll, no Enter expand/collapse needed for this mode)
   - Right panel when a non-component entity is selected: identical to current (scroll + Enter expand/collapse on component groups)

**AVOID:**
- Do NOT modify tree_view.h/c, split_panel.h/c, scroll.h/c, json_render.h/c, or data_model.h/c -- they need zero changes
- Do NOT create a separate classifier module -- keep classification functions static in tab_ecs.c (same as current pattern)
- Do NOT add a new `component_info_t*` field to display_row_t -- use Approach B from research (component entities are already classified as ENTITY_CLASS_COMPONENT entity nodes in the tree)
  </action>
  <verify>
    Files exist: `ls cels-debug/src/tabs/tab_ecs.h cels-debug/src/tabs/tab_ecs.c`
    Tab_ecs.h declares 4 functions: `grep -c 'tab_ecs_' cels-debug/src/tabs/tab_ecs.h` should output 4
    Classification logic present: `grep -c 'classify_node\|has_tag\|has_component_component' cels-debug/src/tabs/tab_ecs.c` should be >= 3
    Context-sensitive inspector: `grep -c 'ENTITY_CLASS_COMPONENT' cels-debug/src/tabs/tab_ecs.c` should be >= 2
    Annotation function: `grep -c 'annotate_component_entities' cels-debug/src/tabs/tab_ecs.c` should be >= 2
  </verify>
  <done>
    tab_ecs.h declares tab_ecs_init/fini/draw/input.
    tab_ecs.c contains all classification logic from tab_entities.c, context-sensitive inspector branching on ENTITY_CLASS_COMPONENT, and component entity annotation from registry data.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update wiring files (tab_system, main, tui, CMake) and delete old tab files</name>
  <files>
    cels-debug/src/tab_system.h
    cels-debug/src/tab_system.c
    cels-debug/src/main.c
    cels-debug/src/tui.c
    cels-debug/CMakeLists.txt
  </files>
  <action>
**tab_system.h** (1 line change):
- Change `#define TAB_COUNT 5` to `#define TAB_COUNT 4`
- Update comment on `active` field from `[0..5]` to `[0..3]`

**tab_system.c** (restructure tab_defs array):
- Replace `#include "tabs/tab_entities.h"` with `#include "tabs/tab_ecs.h"`
- Remove any include of tab_components.h (there is none currently, but verify)
- Replace the 5-entry tab_defs array with 4 entries:
  ```
  [0] "Overview"     ENDPOINT_STATS_WORLD | ENDPOINT_QUERY      -> tab_overview_*
  [1] "ECS"          ENDPOINT_QUERY | ENDPOINT_ENTITY | ENDPOINT_COMPONENTS -> tab_ecs_*
  [2] "Performance"  ENDPOINT_STATS_WORLD | ENDPOINT_STATS_PIPELINE -> tab_placeholder_*
  [3] "State"        ENDPOINT_NONE -> tab_placeholder_*
  ```
- The "Systems" placeholder tab is REMOVED (system entities already appear under the Systems section in the CELS-C tree)

**main.c** (1 line change):
- Change `ch >= '1' && ch <= '5'` to `ch >= '1' && ch <= '0' + TAB_COUNT`
- This makes the key range derive from TAB_COUNT so it never goes out of sync again

**tui.c** (1 line change):
- Change footer text from `"1-5:tabs  jk:nav  Enter:expand  f:anon  q:quit"` to `"1-4:tabs  jk:nav  Enter:expand  f:anon  q:quit"`

**CMakeLists.txt** (1 line change):
- Replace `src/tabs/tab_entities.c` with `src/tabs/tab_ecs.c` in the add_executable source list
- tab_components.c is already NOT in the build, so no removal needed there

**Delete old files** (do NOT physically delete -- just leave them unreferenced):
- tab_entities.h, tab_entities.c, tab_components.h, tab_components.c remain on disk but are not built or included
- They can be cleaned up in a future commit if desired
- Reason: keeping them means easy diffing and rollback if something goes wrong

**Build verification:**
- Run `cmake --build` from the build directory to confirm compilation succeeds with the new wiring
  </action>
  <verify>
    Compile: `cd /home/cachy/workspaces/libs/cels && cmake --build build --target cels-debug 2>&1 | tail -5` should show successful build
    TAB_COUNT: `grep 'TAB_COUNT' cels-debug/src/tab_system.h` should show 4
    Tab defs: `grep -c 'tab_ecs_' cels-debug/src/tab_system.c` should be >= 4
    Key range: `grep 'TAB_COUNT' cels-debug/src/main.c` should match
    Footer: `grep '1-4' cels-debug/src/tui.c` should match
    CMake: `grep 'tab_ecs' cels-debug/CMakeLists.txt` should match
    No tab_entities reference in build: `grep 'tab_entities' cels-debug/CMakeLists.txt` should produce no output
  </verify>
  <done>
    Project compiles with 4 tabs (Overview, ECS, Performance, State).
    TAB_COUNT is 4 in tab_system.h.
    Tab defs array references tab_ecs functions.
    Main loop key range derives from TAB_COUNT.
    Footer says "1-4:tabs".
    CMakeLists.txt builds tab_ecs.c, not tab_entities.c.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    4-tab layout (Overview, ECS, Performance, State) with unified ECS tab containing CELS-C tree view and context-sensitive inspector panel.
  </what-built>
  <how-to-verify>
    1. Run the CELS example app: `cd /home/cachy/workspaces/libs/cels && ./run.sh app` (in one terminal)
    2. Run the debugger: `./run.sh debug` (in another Kitty terminal, NOT VS Code)
    3. Verify tab bar shows exactly 4 tabs: Overview, ECS, Performance, State
    4. Press 2 to activate ECS tab -- should show CELS-C tree with 5 collapsed section headers (Compositions, Entities, Lifecycles, Systems, Components)
    5. First letter of each section name should be bold
    6. Navigate with j/k to a section header, press Enter to expand it
    7. Select an entity from Compositions/Entities section -- inspector (right panel) should show component values
    8. Expand the Components section -- should show component type names with entity count annotations (e.g., "15 entities, 8B")
    9. Select a component type entity from Components section -- inspector should show a list of entities that have that component (NOT the component entity's own detail)
    10. Press 5 -- nothing should happen (only 4 tabs)
    11. Press 1-4 to switch tabs -- all should work
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `cmake --build build --target cels-debug` compiles cleanly (zero errors, zero warnings)
- Tab bar renders 4 labels: Overview, ECS, Performance, State
- ECS tab renders split panel with CELS-C tree (left) and inspector (right)
- All 5 CELS-C section headers appear when entities exist
- Component type entities show registry annotation (entity count + optional size)
- Context-sensitive inspector: component selection shows entities-with-component, entity selection shows component values
- Key '5' does nothing; keys '1'-'4' switch tabs correctly
- Footer shows "1-4:tabs"
</verification>

<success_criteria>
1. Build succeeds with zero errors
2. 4-tab layout visible in tab bar
3. ECS tab tree view shows 5 CELS-C sections, all start collapsed
4. Selecting entity from any non-Component section shows component values in inspector
5. Selecting component type from Components section shows entities-with-component list in inspector
6. Component entities annotated with entity count from registry
7. j/k/Enter navigation works through section headers and entity items
8. No references to tab_entities or tab_components in built code (CMakeLists.txt, tab_system.c)
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-redesign-navigation-ecs-tabs/03.1-01-SUMMARY.md`
</output>
