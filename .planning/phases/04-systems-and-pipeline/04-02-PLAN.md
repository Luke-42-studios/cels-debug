---
phase: 04-systems-and-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - tools/cels-debug/src/tree_view.h
  - tools/cels-debug/src/tree_view.c
  - tools/cels-debug/src/data_model.h
autonomous: true

must_haves:
  truths:
    - "Systems section in CELS-C tree shows systems grouped under phase sub-headers (OnUpdate, OnStore, etc.)"
    - "Phase sub-headers are collapsible (Enter toggles), start expanded"
    - "Empty phase groups are hidden -- only phases with registered systems appear"
    - "Each system row shows name, color-coded phase tag, and entity match count"
    - "Disabled systems render in dimmed text"
  artifacts:
    - path: "tools/cels-debug/src/data_model.h"
      provides: "system_match_count and disabled fields on entity_node_t"
      contains: "system_match_count"
    - path: "tools/cels-debug/src/tree_view.h"
      provides: "Extended display_row_t with phase_group field, phase collapse state in tree_view_t"
      contains: "phase_group"
    - path: "tools/cels-debug/src/tree_view.c"
      provides: "Phase sub-header rendering, phase grouping in rebuild, phase collapse toggling, phase_color_pair helper"
      contains: "phase_group"
  key_links:
    - from: "tools/cels-debug/src/tree_view.c"
      to: "display_row_t.phase_group"
      via: "phase sub-headers inserted during rebuild"
      pattern: "phase_group"
    - from: "tools/cels-debug/src/tree_view.c"
      to: "tree_view_t phase state"
      via: "set_phases populates phase arrays, rebuild uses them"
      pattern: "tree_view_set_phases"
---

<objective>
Extend tree_view with phase sub-header support and enrich entity_node_t with pipeline stats fields. This adds the display_row_t phase_group field, phase collapse state, phase sub-header rendering, and phase-color-coded system rows.

Purpose: The tree view needs to group systems under collapsible phase headers and render enriched system data (match counts, disabled state). This plan provides the tree_view infrastructure that Plan 03 wires up with enrichment data and inspector branches.
Output: tree_view.h/c extended with phase grouping, data_model.h extended with system fields, phase sub-header rendering working.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@tools/cels-debug/.planning/PROJECT.md
@tools/cels-debug/.planning/ROADMAP.md
@tools/cels-debug/.planning/STATE.md
@tools/cels-debug/.planning/phases/04-systems-and-pipeline/04-RESEARCH.md
@tools/cels-debug/.planning/phases/04-systems-and-pipeline/04-CONTEXT.md
@tools/cels-debug/.planning/phases/04-systems-and-pipeline/04-01-SUMMARY.md

@tools/cels-debug/src/tree_view.h
@tools/cels-debug/src/tree_view.c
@tools/cels-debug/src/data_model.h
@tools/cels-debug/src/tui.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: data_model.h fields + tree_view.h structs + tree_view.c phase infrastructure</name>
  <files>
    tools/cels-debug/src/data_model.h
    tools/cels-debug/src/tree_view.h
    tools/cels-debug/src/tree_view.c
  </files>
  <action>
**data_model.h** -- Add two fields to entity_node_t (after existing fields, before the closing brace):
```c
int system_match_count;   /* match count from pipeline stats, 0 if not a system */
bool disabled;            /* system disabled from pipeline stats */
```
These are zero-initialized by calloc. Only populated for ENTITY_CLASS_SYSTEM entities during enrichment (Plan 03).

**tree_view.h** -- Extend display_row_t to add phase_group:
```c
typedef struct display_row {
    entity_node_t *node;   /* Non-NULL = entity row, NULL = header */
    int section_idx;       /* Which CELS-C section this belongs to */
    int phase_group;       /* -1 = section/entity row, >=0 = phase sub-header index */
} display_row_t;
```

Add phase collapse state to tree_view_t:
```c
typedef struct tree_view {
    display_row_t *rows;
    int row_count;
    scroll_state_t scroll;
    bool show_anonymous;
    uint64_t prev_selected_id;

    /* CELS-C section state */
    bool section_collapsed[ENTITY_CLASS_COUNT];
    int section_item_count[ENTITY_CLASS_COUNT];

    /* Phase sub-header state (for Systems section) */
    char **phase_names;           /* unique phase names in execution order */
    int *phase_system_counts;     /* system count per phase */
    bool *phase_collapsed;        /* collapse state per phase */
    int phase_count;              /* number of active phases */
} tree_view_t;
```

Add public function declaration:
```c
/* Set phase grouping data for Systems section. Called before rebuild.
 * tree_view owns copies of phase_names (strdup'd internally). */
void tree_view_set_phases(tree_view_t *tv, char **phase_names,
                          int *phase_system_counts, int phase_count);
```

**tree_view.c** -- All structural changes:

1. `tree_view_init()`: Initialize phase fields to NULL/0.

2. `tree_view_fini()`: Free phase_names strings (strdup'd), free phase_names array, free phase_system_counts, free phase_collapsed.

3. `tree_view_set_phases()` implementation:
   - Free old phase_names strings, then free all three arrays
   - If phase_count == 0, set all to NULL/0, return
   - Allocate new arrays: phase_names (char**), phase_system_counts (int*), phase_collapsed (bool*)
   - strdup each phase name (tree_view owns copies)
   - Copy counts
   - Preserve collapse state: for each new phase name, search old names for match. If found, keep its collapsed state. Otherwise start expanded (false).

4. In `add_header_row()` and `dfs_collect()` (or wherever display_row_t entries are populated): set `phase_group = -1` for all non-phase rows. This is critical -- the new field must be initialized for every row.

5. `tree_view_rebuild_visible()` -- Modify the ENTITY_CLASS_SYSTEM section:
   - For ALL sections EXCEPT ENTITY_CLASS_SYSTEM: behavior unchanged.
   - For ENTITY_CLASS_SYSTEM: add the section header row (phase_group = -1). If not collapsed:
     - For each phase in tv->phase_names order:
       - If phase_system_counts[p] == 0, skip (hide empty groups)
       - Add phase sub-header row: `node=NULL, section_idx=ENTITY_CLASS_SYSTEM, phase_group=p`
       - If phase not collapsed (!tv->phase_collapsed[p]):
         - DFS collect only system root nodes whose class_detail matches this phase name
     - After known phases, collect any remaining system nodes whose class_detail does NOT match any known phase name (unknown/custom phases) -- group them under a "Custom" sub-header if any exist.
   - Update max_rows allocation: add `tv->phase_count + 1` for phase sub-headers + potential "Custom" group.

6. `tree_view_toggle_expand()`: When `!cur->node`:
   - If `cur->phase_group >= 0`: toggle `tv->phase_collapsed[cur->phase_group]`
   - If `cur->phase_group == -1`: toggle section collapse (existing behavior)

7. Add `phase_color_pair()` static helper. This is the canonical location for phase-to-color mapping:
```c
static int phase_color_pair(const char *phase) {
    if (!phase) return CP_PHASE_CUSTOM;
    if (strcmp(phase, "OnLoad") == 0)      return CP_PHASE_ONLOAD;
    if (strcmp(phase, "PostLoad") == 0)    return CP_PHASE_POSTLOAD;
    if (strcmp(phase, "PreUpdate") == 0)   return CP_PHASE_PREUPDATE;
    if (strcmp(phase, "OnUpdate") == 0)    return CP_PHASE_ONUPDATE;
    if (strcmp(phase, "OnValidate") == 0)  return CP_PHASE_ONVALIDATE;
    if (strcmp(phase, "PostUpdate") == 0)  return CP_PHASE_POSTUPDATE;
    if (strcmp(phase, "PreStore") == 0)    return CP_PHASE_PRESTORE;
    if (strcmp(phase, "OnStore") == 0)     return CP_PHASE_ONSTORE;
    if (strcmp(phase, "PostFrame") == 0)   return CP_PHASE_POSTFRAME;
    if (strcmp(phase, "OnStart") == 0)     return CP_PHASE_ONLOAD; /* reuse blue */
    return CP_PHASE_CUSTOM;
}
```

8. Add `draw_phase_subheader()` static helper:
```c
static void draw_phase_subheader(WINDOW *win, int row, int max_cols,
                                  const char *phase_name, int sys_count,
                                  bool collapsed, bool is_cursor, int color_pair) {
    if (is_cursor) {
        wattron(win, A_REVERSE);
        wmove(win, row, 1);
        for (int c = 0; c < max_cols; c++) waddch(win, ' ');
    }

    /* Indented under section header */
    mvwprintw(win, row, 3, "%s ", collapsed ? ">" : "v");

    /* Phase name in color */
    wattron(win, COLOR_PAIR(color_pair) | A_BOLD);
    wprintw(win, "%s", phase_name);
    wattroff(win, COLOR_PAIR(color_pair) | A_BOLD);

    /* System count */
    wattron(win, A_DIM);
    wprintw(win, " (%d)", sys_count);
    wattroff(win, A_DIM);

    if (is_cursor) wattroff(win, A_REVERSE);
}
```

9. `tree_view_render()` -- In the main render loop, when `!dr->node`:
   - If `dr->phase_group >= 0`: call `draw_phase_subheader()` with phase data from tv arrays
   - If `dr->phase_group == -1`: existing `draw_section_header()` call

10. `tree_view_render()` -- For entity rows where `node->entity_class == ENTITY_CLASS_SYSTEM`:
    - Render `[phase]` in phase color using `phase_color_pair(node->class_detail)` instead of CP_COMPONENT_HEADER
    - After the phase tag, render `(N)` for system_match_count if > 0
    - If `node->disabled`, wrap the entire row in A_DIM: `wattron(win, A_DIM)` before, `wattroff(win, A_DIM)` after
  </action>
  <verify>
Build compiles: `cd /home/cachy/workspaces/libs/cels && cmake --build build --target cels_debug 2>&1 | tail -10`.
Verify that tree_view.h has phase_group in display_row_t and phase arrays in tree_view_t. Verify that data_model.h has system_match_count and disabled on entity_node_t.
  </verify>
  <done>
display_row_t extended with phase_group field (-1 for non-phase rows, >=0 for phase sub-headers). tree_view_t has phase collapse state arrays. tree_view_set_phases() manages phase data with strdup'd ownership. rebuild_visible groups ENTITY_CLASS_SYSTEM under phase sub-headers. Phase sub-headers are collapsible. System rows rendered with color-coded phase tags, match counts, and dim-on-disabled. entity_node_t has system_match_count and disabled fields. phase_color_pair() defined in tree_view.c as canonical location.
  </done>
</task>

</tasks>

<verification>
1. Build succeeds with zero warnings
2. display_row_t has phase_group field, initialized to -1 for all non-phase rows
3. tree_view_t tracks phase_names, phase_system_counts, phase_collapsed arrays
4. tree_view_set_phases() strdup's phase names, preserves collapse state across calls
5. rebuild_visible creates phase sub-header rows for non-empty phases
6. toggle_expand handles phase sub-headers (phase_group >= 0) separately from section headers
7. System entity rows use phase_color_pair for class_detail tag color
8. Disabled system rows render dimmed
</verification>

<success_criteria>
- display_row_t extended with phase_group field
- tree_view_t tracks phase collapse state
- tree_view_rebuild_visible groups ENTITY_CLASS_SYSTEM nodes under phase sub-headers
- Phase sub-headers are collapsible via Enter key
- Empty phases hidden in rebuild
- System rows show color-coded [Phase] tags using phase_color_pair()
- System rows show (N) match count
- Disabled systems render with A_DIM
- entity_node_t has system_match_count and disabled fields
- phase_color_pair() helper lives in tree_view.c
</success_criteria>

<output>
After completion, create `.planning/phases/04-systems-and-pipeline/04-02-SUMMARY.md`
</output>
