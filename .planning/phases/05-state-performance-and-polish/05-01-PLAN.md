---
phase: 05-state-performance-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cels-debug/src/tabs/tab_ecs.c
  - cels-debug/src/tabs/tab_ecs.h
  - cels-debug/src/tabs/tab_cels.c
  - cels-debug/src/tabs/tab_cels.h
  - cels-debug/src/tabs/tab_systems.c
  - cels-debug/src/tabs/tab_systems.h
  - cels-debug/src/tab_system.c
  - cels-debug/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Tab bar shows 4 tabs: Overview, CELS, Systems, Performance"
    - "CELS tab displays Compositions, Entities, Lifecycles, Components sections (no Systems section)"
    - "Systems tab displays systems grouped by execution phase with detail inspector"
    - "Cross-navigation from Systems tab jumps to CELS tab (index 1)"
    - "Application builds and runs without errors"
  artifacts:
    - path: "cels-debug/src/tabs/tab_cels.c"
      provides: "Renamed CELS tab (formerly tab_ecs) without Systems section"
      contains: "tab_cels_init"
    - path: "cels-debug/src/tabs/tab_cels.h"
      provides: "CELS tab header"
      exports: ["tab_cels_init", "tab_cels_fini", "tab_cels_draw", "tab_cels_input"]
    - path: "cels-debug/src/tabs/tab_systems.c"
      provides: "Extracted Systems tab with phase grouping and detail inspector"
      contains: "tab_systems_init"
    - path: "cels-debug/src/tabs/tab_systems.h"
      provides: "Systems tab header"
      exports: ["tab_systems_init", "tab_systems_fini", "tab_systems_draw", "tab_systems_input"]
  key_links:
    - from: "cels-debug/src/tab_system.c"
      to: "tabs/tab_cels.h, tabs/tab_systems.h"
      via: "#include and tab_defs array"
      pattern: "tab_cels_init|tab_systems_init"
    - from: "cels-debug/CMakeLists.txt"
      to: "tabs/tab_cels.c, tabs/tab_systems.c"
      via: "add_executable source list"
      pattern: "tab_cels\\.c|tab_systems\\.c"
---

<objective>
Restructure the tab layout from [Overview, ECS, Performance, State] to [Overview, CELS, Systems, Performance] by renaming tab_ecs to tab_cels (stripping Systems section code) and extracting Systems-related code into a new top-level tab_systems tab.

Purpose: The user decided Systems deserves its own top-level tab, and the ECS tab should be renamed to CELS. This is the foundational restructure that all other Phase 05 plans depend on.

Output: Renamed tab_cels.c/h, new tab_systems.c/h, updated tab wiring in tab_system.c, updated CMakeLists.txt.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@tools/cels-debug/.planning/PROJECT.md
@tools/cels-debug/.planning/ROADMAP.md
@tools/cels-debug/.planning/STATE.md
@tools/cels-debug/.planning/phases/05-state-performance-and-polish/05-CONTEXT.md
@tools/cels-debug/.planning/phases/05-state-performance-and-polish/05-RESEARCH.md

Key source files:
@tools/cels-debug/src/tabs/tab_ecs.c
@tools/cels-debug/src/tabs/tab_ecs.h
@tools/cels-debug/src/tab_system.c
@tools/cels-debug/src/tab_system.h
@tools/cels-debug/src/data_model.h
@tools/cels-debug/src/tree_view.c
@tools/cels-debug/src/tree_view.h
@tools/cels-debug/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename tab_ecs to tab_cels and strip Systems section</name>
  <files>
    cels-debug/src/tabs/tab_cels.c
    cels-debug/src/tabs/tab_cels.h
  </files>
  <action>
    Copy tab_ecs.c to tab_cels.c and tab_ecs.h to tab_cels.h. Then modify tab_cels:

    1. In tab_cels.h:
       - Rename include guard to CELS_DEBUG_TAB_CELS_H
       - Rename all function names: tab_ecs_* -> tab_cels_*

    2. In tab_cels.c:
       - Change #include to "tab_cels.h"
       - Rename all function definitions: tab_ecs_* -> tab_cels_*
       - REMOVE: enrich_systems_with_pipeline() function entirely
       - REMOVE: find_system_info() function
       - REMOVE: build_system_matches() function
       - REMOVE: draw_system_detail() function
       - REMOVE: draw_pipeline_viz() function
       - REMOVE: draw_systems_summary() function
       - REMOVE: PHASE_ORDER[] and PHASE_ORDER_COUNT constants
       - REMOVE: phase_color_pair() static function (no longer needed without systems)
       - REMOVE: The `enrich_systems_with_pipeline()` call in tab_cels_draw
       - REMOVE: The inspector branch for `ENTITY_CLASS_SYSTEM` entities in draw (the `draw_system_detail` call)
       - REMOVE: The inspector branch for system section headers (draw_pipeline_viz, draw_systems_summary)
       - REMOVE: The input handler branches for system detail mode (right panel system scroll + cross-navigate)
       - KEEP: classify_node() but skip ENTITY_CLASS_SYSTEM classification (systems will be classified in tab_systems). Keep the has_tag/has_component_component/extract_pipeline_phase/name_is_lifecycle helpers since they're reused for non-system classification.
       - Actually in classify_node(): KEEP the ENTITY_CLASS_SYSTEM classification as-is. Systems will still appear in the entity list from /query but classify_node() marks them as SYSTEM class, which tab_cels's tree_view will simply not show (since tree_view only shows sections that have items, and ENTITY_CLASS_SYSTEM items in the entity_list will be filtered by tab_cels's modified draw logic). The simplest approach: in tab_cels_draw, after classify_all_entities(), skip calling enrich_systems_with_pipeline() and the tree_view will have 0 phase data, so the Systems section header still shows with a count but no phase sub-headers. OR, cleaner: skip sections for ENTITY_CLASS_SYSTEM in the CELS tab by checking section_item_count[ENTITY_CLASS_SYSTEM] = 0 after classification. The cleanest approach: after classify_all_entities(), set section_item_count override by zeroing out SYSTEM count so the section header doesn't appear.
       - SIMPLEST approach for hiding systems: After classify_all_entities() and before tree_view_rebuild_visible(), iterate entity_list->roots and skip ENTITY_CLASS_SYSTEM nodes by not including them. But tree_view_rebuild_visible uses entity_class on the nodes directly. Better: Just leave classify as-is and in tab_cels_draw, after classify_all_entities, reclassify ENTITY_CLASS_SYSTEM nodes to a hidden class OR manually set tree.section_item_count[ENTITY_CLASS_SYSTEM] = 0 before rebuild -- no, rebuild recounts. BEST approach: Leave tree_view_rebuild_visible as-is. The Systems section will show in the CELS tab tree with entities. This is acceptable because (a) tree_view respects section_collapsed state, so it starts collapsed, and (b) the user will typically not interact with it in the CELS tab since they have a dedicated Systems tab now. BUT per CONTEXT.md, the CELS tab sections should be C-E-L-S-C = Compositions, Entities, Lifecycles, State, Components. No Systems. So we DO need to exclude systems.
       - FINAL approach: In tab_cels_draw, after classify_all_entities(), add a loop that reclassifies ENTITY_CLASS_SYSTEM nodes. Since we're removing SYSTEM and replacing with STATE in Plan 02, for now just skip: after classify, reclassify any ENTITY_CLASS_SYSTEM nodes as ENTITY_CLASS_ENTITY (fallback to generic entity). This way the tree_view won't create a Systems section header. Plan 02 will introduce ENTITY_CLASS_STATE and reclassify properly.
       - Remove the cross_navigate_to_entity code that references ENTITY_CLASS_SYSTEM sections specifically. Keep the generic cross-navigation to Entities/Compositions sections.

    3. Update split_panel_draw_borders label from "ECS" to "CELS":
       - Change `split_panel_draw_borders(&es->panel, "ECS", "Inspector")` to `split_panel_draw_borders(&es->panel, "CELS", "Inspector")`

    4. Update endpoint bitmask: tab_cels no longer needs ENDPOINT_STATS_PIPELINE (that moves to Systems tab). The bitmask is set in tab_system.c's tab_defs array, not in tab_cels.c itself, so this is handled in Task 2.

    Do NOT delete tab_ecs.c/tab_ecs.h yet -- they become dead code but removal can happen in cleanup.
  </action>
  <verify>
    Files exist: `ls cels-debug/src/tabs/tab_cels.c cels-debug/src/tabs/tab_cels.h`
    No references to "tab_ecs" in new files: `grep -r "tab_ecs" cels-debug/src/tabs/tab_cels.*` should return nothing
    Functions renamed: `grep "tab_cels_init\|tab_cels_fini\|tab_cels_draw\|tab_cels_input" cels-debug/src/tabs/tab_cels.c`
    Systems-specific code removed: `grep "draw_system_detail\|draw_pipeline_viz\|draw_systems_summary\|enrich_systems_with_pipeline" cels-debug/src/tabs/tab_cels.c` should return nothing
  </verify>
  <done>tab_cels.c exists with all tab_ecs_* renamed to tab_cels_*, all Systems-specific inspector/enrichment code removed, ENTITY_CLASS_SYSTEM nodes reclassified to hide Systems section from the CELS tab tree.</done>
</task>

<task type="auto">
  <name>Task 2: Create tab_systems and update tab wiring</name>
  <files>
    cels-debug/src/tabs/tab_systems.c
    cels-debug/src/tabs/tab_systems.h
    cels-debug/src/tab_system.c
    cels-debug/CMakeLists.txt
  </files>
  <action>
    1. Create tab_systems.h with the same pattern as tab_cels.h:
       - Include guard CELS_DEBUG_TAB_SYSTEMS_H
       - #include "../tab_system.h"
       - Declare: tab_systems_init, tab_systems_fini, tab_systems_draw, tab_systems_input

    2. Create tab_systems.c by extracting Systems-related code from the original tab_ecs.c:
       - Same includes as tab_ecs.c (split_panel, tree_view, json_render, scroll, data_model, tui, etc.)
       - Copy the per-tab state struct (rename to systems_state_t), containing: split_panel_t panel, tree_view_t tree, scroll_state_t inspector_scroll, bool panel_created. No need for comp_expanded (Systems tab inspector doesn't have component groups).
       - Copy PHASE_ORDER[], PHASE_ORDER_COUNT, phase_color_pair() static function
       - Copy has_tag(), has_component_component(), extract_pipeline_phase() for classification
       - Copy classify_node() but modify: only classify ENTITY_CLASS_SYSTEM (return ENTITY_CLASS_SYSTEM for systems/observers, return ENTITY_CLASS_COUNT or a skip sentinel for everything else). Actually, simpler: use the same classify_node but the tree_view will only show ENTITY_CLASS_SYSTEM section. The tree_view_rebuild_visible iterates sections 0..ENTITY_CLASS_COUNT-1 and only emits headers for sections with items. If we only care about Systems, we can zero out section_item_count for non-SYSTEM classes after rebuild.
       - Better approach: Reuse classify_all_entities() as-is (copy it), then in draw before tree_view_rebuild_visible, manually zero out section_item_count for all classes except ENTITY_CLASS_SYSTEM. Actually tree_view_rebuild_visible recounts section_item_count internally. So we need a different approach.
       - BEST approach: After classify_all_entities() and before rebuild, leave everything as-is. tree_view_rebuild_visible will create headers for all non-empty sections. The Systems section will be present. Other sections (Compositions, Entities, Lifecycles, Components) will also show. That's not what we want -- the Systems tab should ONLY show the Systems section.
       - CLEANEST approach: Don't use tree_view for the Systems tab. Systems tab uses split_panel with a scroll_state for the left panel (system list) and a custom render. The left panel renders systems grouped by phase with sub-headers, similar to how tree_view does it but without the other sections. This avoids trying to hack tree_view to show only one section.
       - Actually, tree_view already supports this via section_collapsed. If we set all non-SYSTEM sections to collapsed AND don't emit their headers, that works. But tree_view_rebuild_visible always emits headers for non-empty sections even when collapsed.
       - PRAGMATIC approach: Use scroll_state_t for the left panel instead of tree_view_t. Build a flat display list of phase headers + system entities. This is simpler for a single-section view. The rendering code copies from tree_view_render but only handles phase sub-headers and system entity rows (no section headers).
       - Define a local display_row_t equivalent (or reuse the same struct from tree_view.h). Use a custom rebuild function that only collects ENTITY_CLASS_SYSTEM entities grouped by phase.
       - Copy enrich_systems_with_pipeline() -- it enriches entity nodes and builds phase lists
       - Copy find_system_info(), build_system_matches(), draw_system_detail()
       - Copy draw_pipeline_viz(), draw_systems_summary() for inspector context
       - Copy cross_navigate_to_entity() but modify: instead of navigating within this tab's tree, it switches to tab index 1 (CELS tab). The cross-navigation function should set the app_state->selected_entity_path and signal a tab switch. Since tab_systems doesn't own the CELS tab's tree_view, the cross-nav just: (a) sets selected_entity_path, (b) returns a signal that the caller should switch to tab 1. Implement by having the input handler directly modify tab state through app_state. Actually, the current cross_navigate_to_entity modifies the tree's section_collapsed and does tree_view_rebuild_visible on the local tree. For cross-TAB navigation, we just need to set selected_entity_path in app_state -- the CELS tab will pick it up on its next draw cycle. The tab switch must happen in main.c's input loop. Since tab_systems can't directly switch tabs, use a convention: set a field in app_state (e.g., pending_tab_switch) or return the tab index. Simplest: add an `int pending_tab` field to app_state_t (default -1 = no switch). When cross-nav fires in tab_systems, set pending_tab = 1. Main loop checks after tab_system_handle_input and switches if pending_tab >= 0.
       - Actually even simpler: the Systems tab doesn't need cross-navigation to the CELS tab in v0.1. The current cross-nav in tab_ecs is WITHIN the same tab (system inspector -> entity in the same tree). Cross-TAB navigation is a Plan 04 concern (nav polish). For now, just show the system detail inspector with matched entities list but without cross-nav Enter action. Or implement the pending_tab approach since it's simple.
       - Go with: add `int pending_tab` to app_state_t in tui.h (default -1). tab_systems cross-nav sets it to 1 + sets selected_entity_path. Main loop checks after input handling. This is 3 lines in main.c.

    3. Update tab_system.c:
       - Replace `#include "tabs/tab_ecs.h"` with `#include "tabs/tab_cels.h"` and add `#include "tabs/tab_systems.h"`
       - Remove `#include "tabs/tab_placeholder.h"` (no more placeholders)
       - Update tab_defs[4]:
         [0] "Overview" -> tab_overview (unchanged)
         [1] "CELS" -> tab_cels_init/fini/draw/input, endpoints: ENDPOINT_QUERY | ENDPOINT_ENTITY | ENDPOINT_COMPONENTS
         [2] "Systems" -> tab_systems_init/fini/draw/input, endpoints: ENDPOINT_QUERY | ENDPOINT_ENTITY | ENDPOINT_STATS_PIPELINE
         [3] "Performance" -> tab_placeholder (still placeholder until Plan 03), endpoints: ENDPOINT_STATS_WORLD | ENDPOINT_STATS_PIPELINE

    4. Update CMakeLists.txt:
       - Replace `src/tabs/tab_ecs.c` with `src/tabs/tab_cels.c`
       - Add `src/tabs/tab_systems.c`
       - Keep `src/tabs/tab_placeholder.c` (still used by Performance until Plan 03)

    5. Update tui.h:
       - Add `int pending_tab;` field to app_state_t (for cross-tab navigation from Systems)

    6. Update main.c:
       - Initialize `app_state.pending_tab = -1;`
       - After `tab_system_handle_input()` call, check: `if (app_state.pending_tab >= 0) { tab_system_activate(&tabs, app_state.pending_tab); app_state.pending_tab = -1; }`
  </action>
  <verify>
    Build: `cd /home/cachy/workspaces/libs/cels && cmake --build build 2>&1 | tail -5` -- should compile with 0 errors
    Run test: `cd /home/cachy/workspaces/libs/cels && timeout 3 ./build/tools/cels-debug/cels-debug 2>&1 || true` -- should launch and exit cleanly
    Tab wiring: `grep -n "CELS\|Systems\|tab_cels\|tab_systems" cels-debug/src/tab_system.c` confirms new tab names
  </verify>
  <done>
    Application builds and runs with 4 tabs: Overview, CELS, Systems, Performance.
    CELS tab shows entity tree without Systems section.
    Systems tab shows systems grouped by phase with detail inspector.
    Performance tab shows placeholder (to be replaced in Plan 03).
    Cross-tab navigation from Systems to CELS works via pending_tab mechanism.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build` succeeds with 0 errors and 0 warnings
2. Application launches, tab bar shows "1:Overview 2:CELS 3:Systems 4:Performance"
3. Pressing 2 shows the CELS tab with C-E-L-C sections (Compositions, Entities, Lifecycles, Components) -- no Systems section
4. Pressing 3 shows the Systems tab with phase-grouped systems, detail inspector works
5. No crashes on tab switching, resize, or quit
</verification>

<success_criteria>
- Tab bar reads: Overview, CELS, Systems, Performance (4 tabs)
- CELS tab has no Systems section (system entities reclassified or filtered)
- Systems tab renders identically to the old ECS tab's Systems section
- Build produces 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-state-performance-and-polish/05-01-SUMMARY.md`
</output>
