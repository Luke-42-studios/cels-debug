---
phase: 05-state-performance-and-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - cels-debug/src/tabs/tab_cels.c
  - cels-debug/src/tabs/tab_cels.h
  - cels-debug/src/tabs/tab_systems.c
  - cels-debug/src/tabs/tab_systems.h
  - cels-debug/src/tab_system.c
  - cels-debug/src/tui.h
  - cels-debug/src/main.c
  - cels-debug/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "Tab bar shows 4 tabs: Overview, CELS, Systems, Performance"
    - "CELS tab displays Compositions, Entities, Lifecycles, Components sections (no Systems section)"
    - "Systems tab displays systems grouped by execution phase with detail inspector"
    - "Cross-navigation from Systems tab jumps to CELS tab (index 1)"
    - "Application builds and runs without errors"
    - "Only the active tab's required endpoints are polled"
  artifacts:
    - path: "cels-debug/src/tabs/tab_cels.c"
      provides: "Renamed CELS tab (formerly tab_ecs) without Systems section"
      contains: "tab_cels_init"
    - path: "cels-debug/src/tabs/tab_cels.h"
      provides: "CELS tab header"
      exports: ["tab_cels_init", "tab_cels_fini", "tab_cels_draw", "tab_cels_input"]
    - path: "cels-debug/src/tabs/tab_systems.c"
      provides: "Extracted Systems tab with phase grouping and detail inspector"
      contains: "tab_systems_init"
    - path: "cels-debug/src/tabs/tab_systems.h"
      provides: "Systems tab header"
      exports: ["tab_systems_init", "tab_systems_fini", "tab_systems_draw", "tab_systems_input"]
  key_links:
    - from: "cels-debug/src/tab_system.c"
      to: "tabs/tab_cels.h, tabs/tab_systems.h"
      via: "#include and tab_defs array"
      pattern: "tab_cels_init|tab_systems_init"
    - from: "cels-debug/CMakeLists.txt"
      to: "tabs/tab_cels.c, tabs/tab_systems.c"
      via: "add_executable source list"
      pattern: "tab_cels\\.c|tab_systems\\.c"
---

<objective>
Restructure the tab layout from [Overview, ECS, Performance, State] to [Overview, CELS, Systems, Performance] by renaming tab_ecs to tab_cels (stripping Systems section code) and extracting Systems-related code into a new top-level tab_systems tab.

Purpose: The user decided Systems deserves its own top-level tab, and the ECS tab should be renamed to CELS. This is the foundational restructure that all other Phase 05 plans depend on.

Output: Renamed tab_cels.c/h, new tab_systems.c/h, updated tab wiring in tab_system.c, updated CMakeLists.txt.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@tools/cels-debug/.planning/PROJECT.md
@tools/cels-debug/.planning/ROADMAP.md
@tools/cels-debug/.planning/STATE.md
@tools/cels-debug/.planning/phases/05-state-performance-and-polish/05-CONTEXT.md
@tools/cels-debug/.planning/phases/05-state-performance-and-polish/05-RESEARCH.md

Key source files:
@tools/cels-debug/src/tabs/tab_ecs.c
@tools/cels-debug/src/tabs/tab_ecs.h
@tools/cels-debug/src/tab_system.c
@tools/cels-debug/src/tab_system.h
@tools/cels-debug/src/data_model.h
@tools/cels-debug/src/tree_view.c
@tools/cels-debug/src/tree_view.h
@tools/cels-debug/CMakeLists.txt
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename tab_ecs to tab_cels and strip Systems section</name>
  <files>
    cels-debug/src/tabs/tab_cels.c
    cels-debug/src/tabs/tab_cels.h
  </files>
  <action>
    Copy tab_ecs.c to tab_cels.c and tab_ecs.h to tab_cels.h. Then modify tab_cels:

    1. In tab_cels.h:
       - Rename include guard to CELS_DEBUG_TAB_CELS_H
       - Rename all function names: tab_ecs_* -> tab_cels_*

    2. In tab_cels.c:
       - Change #include to "tab_cels.h"
       - Rename all function definitions: tab_ecs_* -> tab_cels_*
       - REMOVE these functions entirely: enrich_systems_with_pipeline(), find_system_info(), build_system_matches(), draw_system_detail(), draw_pipeline_viz(), draw_systems_summary()
       - REMOVE PHASE_ORDER[] and PHASE_ORDER_COUNT constants
       - REMOVE phase_color_pair() static function
       - REMOVE the enrich_systems_with_pipeline() call in tab_cels_draw
       - REMOVE the inspector branch for ENTITY_CLASS_SYSTEM entities (draw_system_detail call)
       - REMOVE the inspector branch for system section headers (draw_pipeline_viz, draw_systems_summary)
       - REMOVE the input handler branches for system detail mode
       - KEEP classify_node() with all existing classification logic including ENTITY_CLASS_SYSTEM detection. Keep all helpers (has_tag, has_component_component, extract_pipeline_phase, name_is_lifecycle).

    3. Hide Systems section from CELS tab tree: After classify_all_entities() in tab_cels_draw, add a loop that reclassifies any ENTITY_CLASS_SYSTEM nodes as ENTITY_CLASS_ENTITY (fallback). This prevents the tree_view from creating a Systems section header. Plan 02 will later introduce ENTITY_CLASS_STATE and reclassify properly.

    4. Update split_panel_draw_borders label from "ECS" to "CELS".

    5. Do NOT delete tab_ecs.c/tab_ecs.h -- they become dead code but removal can happen in cleanup.
  </action>
  <verify>
    Files exist: `ls cels-debug/src/tabs/tab_cels.c cels-debug/src/tabs/tab_cels.h`
    No references to "tab_ecs" in new files: `grep -r "tab_ecs" cels-debug/src/tabs/tab_cels.*` should return nothing
    Functions renamed: `grep "tab_cels_init\|tab_cels_fini\|tab_cels_draw\|tab_cels_input" cels-debug/src/tabs/tab_cels.c`
    Systems-specific code removed: `grep "draw_system_detail\|draw_pipeline_viz\|draw_systems_summary\|enrich_systems_with_pipeline" cels-debug/src/tabs/tab_cels.c` should return nothing
  </verify>
  <done>tab_cels.c exists with all tab_ecs_* renamed to tab_cels_*, all Systems-specific inspector/enrichment code removed, ENTITY_CLASS_SYSTEM nodes reclassified to ENTITY_CLASS_ENTITY to hide Systems section from the CELS tab tree.</done>
</task>

<task type="auto">
  <name>Task 2: Create tab_systems with scroll_state flat-list approach</name>
  <files>
    cels-debug/src/tabs/tab_systems.c
    cels-debug/src/tabs/tab_systems.h
  </files>
  <action>
    1. Create tab_systems.h:
       - Include guard CELS_DEBUG_TAB_SYSTEMS_H
       - #include "../tab_system.h"
       - Declare: tab_systems_init, tab_systems_fini, tab_systems_draw, tab_systems_input

    2. Create tab_systems.c using a scroll_state_t flat display list (NOT tree_view_t). The Systems tab shows only system entities grouped by phase -- a flat scrollable list is simpler and more appropriate than hacking tree_view to show a single section.

    3. Per-tab state (systems_state_t): split_panel_t panel, scroll_state_t left_scroll, scroll_state_t inspector_scroll, bool panel_created. Add a flat display list: an array of display_entry_t structs where each entry is either a phase header or a system entity row.

    4. Define display_entry_t:
       ```c
       typedef struct {
           bool is_header;           /* true = phase header row */
           const char *phase_name;   /* phase name for headers */
           int phase_color;          /* color pair for phase */
           int system_count;         /* systems in phase (headers only) */
           entity_node_t *entity;    /* entity pointer (system rows only) */
       } display_entry_t;
       ```

    5. Copy from original tab_ecs.c:
       - PHASE_ORDER[], PHASE_ORDER_COUNT, phase_color_pair()
       - has_tag(), has_component_component(), extract_pipeline_phase() for classification
       - enrich_systems_with_pipeline() -- enriches entity nodes with pipeline phase data
       - find_system_info(), build_system_matches(), draw_system_detail()
       - draw_pipeline_viz(), draw_systems_summary()

    6. Build the flat display list in a rebuild function: iterate PHASE_ORDER, for each phase collect ENTITY_CLASS_SYSTEM entities with matching phase, emit a phase header entry then system entity entries. Use scroll_state_t for cursor/offset tracking over this flat list.

    7. Render the left panel: iterate visible entries in the display list, drawing phase headers (bold, colored, with count) and system rows (indented, with timing info). Highlight the cursor row.

    8. Inspector (right panel): when cursor is on a system entity row, show draw_system_detail with matched entities list. When cursor is on a phase header, show draw_pipeline_viz / draw_systems_summary for that phase.

    9. Input handling: j/k for scroll, Enter to expand/select, standard split_panel focus switching.
  </action>
  <verify>
    Files exist: `ls cels-debug/src/tabs/tab_systems.c cels-debug/src/tabs/tab_systems.h`
    Functions declared: `grep "tab_systems_init\|tab_systems_draw" cels-debug/src/tabs/tab_systems.h`
    Uses scroll_state (not tree_view): `grep "scroll_state_t" cels-debug/src/tabs/tab_systems.c` returns matches; `grep "tree_view_t" cels-debug/src/tabs/tab_systems.c` returns nothing
    Has phase grouping: `grep "PHASE_ORDER\|phase_color_pair" cels-debug/src/tabs/tab_systems.c`
  </verify>
  <done>tab_systems.c implements a flat-list Systems tab using scroll_state_t with phase-grouped display entries, system detail inspector, and pipeline visualization.</done>
</task>

<task type="auto">
  <name>Task 3: Wire tabs, build system, and pending_tab cross-navigation</name>
  <files>
    cels-debug/src/tab_system.c
    cels-debug/src/tui.h
    cels-debug/src/main.c
    cels-debug/CMakeLists.txt
  </files>
  <action>
    1. In tab_system.c:
       - Replace `#include "tabs/tab_ecs.h"` with `#include "tabs/tab_cels.h"`
       - Add `#include "tabs/tab_systems.h"`
       - Remove `#include "tabs/tab_placeholder.h"` (no more placeholders)
       - Update tab_defs[4]:
         [0] "Overview" -> tab_overview (unchanged)
         [1] "CELS" -> tab_cels_init/fini/draw/input, endpoints: ENDPOINT_QUERY | ENDPOINT_ENTITY | ENDPOINT_COMPONENTS
         [2] "Systems" -> tab_systems_init/fini/draw/input, endpoints: ENDPOINT_QUERY | ENDPOINT_ENTITY | ENDPOINT_STATS_PIPELINE
         [3] "Performance" -> tab_placeholder (still placeholder until Plan 03), endpoints: ENDPOINT_STATS_WORLD | ENDPOINT_STATS_PIPELINE

    2. In tui.h:
       - Add `int pending_tab;` field to app_state_t (for cross-tab navigation from Systems tab, default -1 = no switch)

    3. In main.c:
       - Initialize `app_state.pending_tab = -1;`
       - After `tab_system_handle_input()` call, check: `if (app_state.pending_tab >= 0) { tab_system_activate(&tabs, app_state.pending_tab); app_state.pending_tab = -1; }`

    4. In CMakeLists.txt:
       - Replace `src/tabs/tab_ecs.c` with `src/tabs/tab_cels.c`
       - Add `src/tabs/tab_systems.c`
       - Keep `src/tabs/tab_placeholder.c` (still used by Performance until Plan 03)
  </action>
  <verify>
    Build: `cd /home/cachy/workspaces/libs/cels && cmake --build build 2>&1 | tail -5` -- should compile with 0 errors
    Run test: `cd /home/cachy/workspaces/libs/cels && timeout 3 ./build/tools/cels-debug/cels-debug 2>&1 || true` -- should launch and exit cleanly
    Tab wiring: `grep -n "CELS\|Systems\|tab_cels\|tab_systems" cels-debug/src/tab_system.c` confirms new tab names
    Endpoint bitmasks correct: `grep "ENDPOINT_" cels-debug/src/tab_system.c` -- verify CELS has QUERY|ENTITY|COMPONENTS (no PIPELINE), Systems has QUERY|ENTITY|STATS_PIPELINE, Performance has STATS_WORLD|STATS_PIPELINE
    Pending tab: `grep "pending_tab" cels-debug/src/tui.h cels-debug/src/main.c`
  </verify>
  <done>
    Application builds and runs with 4 tabs: Overview, CELS, Systems, Performance.
    CELS tab shows entity tree without Systems section.
    Systems tab shows systems grouped by phase with detail inspector.
    Performance tab shows placeholder (to be replaced in Plan 03).
    Cross-tab navigation from Systems to CELS works via pending_tab mechanism.
    Endpoint bitmasks are correct: each tab only polls its required endpoints.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build` succeeds with 0 errors and 0 warnings
2. Application launches, tab bar shows "1:Overview 2:CELS 3:Systems 4:Performance"
3. Pressing 2 shows the CELS tab with C-E-L-C sections (Compositions, Entities, Lifecycles, Components) -- no Systems section
4. Pressing 3 shows the Systems tab with phase-grouped systems, detail inspector works
5. Endpoint bitmasks verified: `grep "ENDPOINT_" cels-debug/src/tab_system.c` shows correct masks per tab (CELS has no PIPELINE, Systems has PIPELINE, Performance has WORLD+PIPELINE)
6. No crashes on tab switching, resize, or quit
</verification>

<success_criteria>
- Tab bar reads: Overview, CELS, Systems, Performance (4 tabs)
- CELS tab has no Systems section (system entities reclassified or filtered)
- Systems tab renders identically to the old ECS tab's Systems section
- Each tab polls only its required endpoints
- Build produces 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-state-performance-and-polish/05-01-SUMMARY.md`
</output>
