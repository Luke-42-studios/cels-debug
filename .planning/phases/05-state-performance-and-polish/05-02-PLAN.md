---
phase: 05-state-performance-and-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - cels-debug/src/data_model.h
  - cels-debug/src/tree_view.c
  - cels-debug/src/tabs/tab_cels.c
autonomous: true

must_haves:
  truths:
    - "CELS tab sections spell C-E-L-S-C: Compositions, Entities, Lifecycles, State, Components"
    - "State section shows lifecycle/state-related entities from entity list"
    - "Selecting a State entity shows its component values in the inspector"
    - "Value changes flash highlighted for ~2 seconds when component data changes between polls"
  artifacts:
    - path: "cels-debug/src/data_model.h"
      provides: "Updated entity_class_t enum with STATE replacing SYSTEM"
      contains: "ENTITY_CLASS_STATE"
    - path: "cels-debug/src/tree_view.c"
      provides: "Updated section_names with State"
      contains: "\"State\""
    - path: "cels-debug/src/tabs/tab_cels.c"
      provides: "State classification heuristic and change highlighting"
      contains: "ENTITY_CLASS_STATE"
  key_links:
    - from: "cels-debug/src/tabs/tab_cels.c"
      to: "data_model.h"
      via: "ENTITY_CLASS_STATE enum value"
      pattern: "ENTITY_CLASS_STATE"
    - from: "cels-debug/src/tree_view.c"
      to: "data_model.h"
      via: "section_names array indexed by entity_class_t"
      pattern: "section_names.*ENTITY_CLASS"
---

<objective>
Add the State section to the CELS tab as the "S" in the CELS-C acronym, replacing the removed Systems enum value. State entities are identified by lifecycle-related heuristics. The inspector shows component values with change highlighting (2-second flash on value change).

Purpose: Completes the CELS-C paradigm in the CELS tab. State is the user-visible representation of CELS state entities, providing insight into lifecycle and state-related entities in the running application.

Output: Updated entity_class_t enum, updated section_names in tree_view.c, State classification heuristic in tab_cels.c, change-highlighting flash in the inspector.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@tools/cels-debug/.planning/PROJECT.md
@tools/cels-debug/.planning/ROADMAP.md
@tools/cels-debug/.planning/phases/05-state-performance-and-polish/05-CONTEXT.md
@tools/cels-debug/.planning/phases/05-state-performance-and-polish/05-RESEARCH.md
@tools/cels-debug/.planning/phases/05-state-performance-and-polish/05-01-SUMMARY.md

Key source files:
@tools/cels-debug/src/data_model.h
@tools/cels-debug/src/tree_view.c
@tools/cels-debug/src/tree_view.h
@tools/cels-debug/src/tabs/tab_cels.c
@tools/cels-debug/src/tabs/tab_cels.h
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update entity_class_t enum and section names</name>
  <files>
    cels-debug/src/data_model.h
    cels-debug/src/tree_view.c
  </files>
  <action>
    1. In data_model.h, update the entity_class_t enum:
       - ENTITY_CLASS_COMPOSITION = 0 (C) -- unchanged
       - ENTITY_CLASS_ENTITY = 1 (E) -- unchanged
       - ENTITY_CLASS_LIFECYCLE = 2 (L) -- unchanged
       - ENTITY_CLASS_STATE = 3 (S) -- NEW, replaces ENTITY_CLASS_SYSTEM
       - ENTITY_CLASS_COMPONENT = 4 (C) -- unchanged value
       - ENTITY_CLASS_COUNT = 5
       - REMOVE: ENTITY_CLASS_SYSTEM entirely (Systems tab uses its own internal classification now, independent of this enum)
       - Update the comment to: "Entity classification -- sections spell CELS-C, mirroring the paradigm"

    2. In tree_view.c, update the section_names array:
       - [ENTITY_CLASS_COMPOSITION] = "Compositions"  (unchanged)
       - [ENTITY_CLASS_ENTITY] = "Entities"  (unchanged)
       - [ENTITY_CLASS_LIFECYCLE] = "Lifecycles"  (unchanged)
       - [ENTITY_CLASS_STATE] = "State"  (NEW - was "Systems")
       - [ENTITY_CLASS_COMPONENT] = "Components"  (unchanged)

    3. In tree_view.c, the tree_view_rebuild_visible function has special handling for ENTITY_CLASS_SYSTEM (phase sub-headers). Remove this special case since ENTITY_CLASS_SYSTEM no longer exists. The ENTITY_CLASS_STATE section should use the standard non-system branch (simple DFS collect without phase sub-headers).

    4. In tree_view.c, the tree_view_render function renders system-specific right-aligned info (phase tags, match counts). The ENTITY_CLASS_STATE nodes won't have these. The existing render code checks `node->entity_class == ENTITY_CLASS_SYSTEM` -- update this to not reference ENTITY_CLASS_SYSTEM (which no longer exists). State entities will render with the generic class_detail or component-list info.

    5. In tree_view.c, the entity row dim_row check: `node->entity_class == ENTITY_CLASS_SYSTEM && node->disabled` -- remove this since ENTITY_CLASS_SYSTEM no longer exists in the enum. State entities don't have a disabled concept.

    IMPORTANT: tab_systems.c (Plan 01) has its OWN copy of entity_class_t handling. It uses the entity_class field on nodes but only cares about systems. Since ENTITY_CLASS_SYSTEM is being removed from the enum, tab_systems.c needs its OWN internal system detection (which it already does via has_tag checks, not via the enum). Verify tab_systems.c from Plan 01 doesn't reference ENTITY_CLASS_SYSTEM directly from the enum -- if it does, it needs to use a local constant or its own tag-based detection.

    Plan 01's tab_systems.c DOES reference ENTITY_CLASS_SYSTEM. Two options:
    (a) Keep ENTITY_CLASS_SYSTEM in the enum alongside ENTITY_CLASS_STATE (bump COUNT to 6) -- simple but messy
    (b) Have tab_systems.c define its own `#define SYSTEMS_CLASS_IDX 3` or use tag-based detection

    Go with option (a) temporarily: keep ENTITY_CLASS_SYSTEM in the enum but AFTER ENTITY_CLASS_STATE. New enum:
       - ENTITY_CLASS_COMPOSITION = 0  (C)
       - ENTITY_CLASS_ENTITY = 1       (E)
       - ENTITY_CLASS_LIFECYCLE = 2    (L)
       - ENTITY_CLASS_STATE = 3        (S) -- NEW
       - ENTITY_CLASS_COMPONENT = 4    (C)
       - ENTITY_CLASS_SYSTEM = 5       (still exists for tab_systems.c classification)
       - ENTITY_CLASS_COUNT = 6

    tree_view.c section_names needs 6 entries. Section index 5 (SYSTEM) won't have items in the CELS tab's tree (tab_cels reclassifies them), so no Systems header appears. tab_systems.c uses its own rendering and doesn't go through tree_view section_names at position 5.

    Actually, tree_view.c section_names is a static array of size ENTITY_CLASS_COUNT. It needs an entry at index 5. Set it to "Systems" (harmless -- tree_view only emits headers for sections with items, and in the CELS tab, SYSTEM entities will be reclassified).

    Updated section_names:
       [ENTITY_CLASS_COMPOSITION] = "Compositions"
       [ENTITY_CLASS_ENTITY] = "Entities"
       [ENTITY_CLASS_LIFECYCLE] = "Lifecycles"
       [ENTITY_CLASS_STATE] = "State"
       [ENTITY_CLASS_COMPONENT] = "Components"
       [ENTITY_CLASS_SYSTEM] = "Systems"

    In tree_view_rebuild_visible: the ENTITY_CLASS_SYSTEM special-case (phase sub-headers) should remain. If the CELS tab's tree_view never has ENTITY_CLASS_SYSTEM items (because tab_cels reclassifies them), this code path is never hit in the CELS tab. But tab_systems might use tree_view with ENTITY_CLASS_SYSTEM items -- if so, the phase sub-header logic is useful. Keep it.
  </action>
  <verify>
    Build succeeds: `cmake --build build 2>&1 | tail -5`
    Enum has STATE: `grep "ENTITY_CLASS_STATE" cels-debug/src/data_model.h`
    Section names updated: `grep '"State"' cels-debug/src/tree_view.c`
  </verify>
  <done>
    entity_class_t enum has ENTITY_CLASS_STATE at position 3, spelling C-E-L-S-C.
    tree_view.c section_names includes "State" at the correct index.
    Build compiles with 0 errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: State classification and change highlighting in CELS tab</name>
  <files>
    cels-debug/src/tabs/tab_cels.c
  </files>
  <action>
    1. Add State classification in tab_cels.c's classify_node() function:
       - Add a new classification rule BEFORE the Lifecycle check:
         State entities are identified by names ending with "State" (matching CEL_State naming convention).
         ```
         if (name_ends_with_state(node)) return ENTITY_CLASS_STATE;
         ```
       - Create helper: `static bool name_ends_with_state(entity_node_t *node)` -- checks if node->name ends with "State" (similar pattern to name_is_lifecycle).
       - Classification priority order in classify_node should be:
         1. Systems -> ENTITY_CLASS_SYSTEM (reclassified to ENTITY_CLASS_ENTITY in draw)
         2. Components -> ENTITY_CLASS_COMPONENT
         3. State -> ENTITY_CLASS_STATE (NEW)
         4. Lifecycles -> ENTITY_CLASS_LIFECYCLE
         5. Leaf entities -> ENTITY_CLASS_ENTITY
         6. Parent entities -> ENTITY_CLASS_COMPOSITION
       - NOTE: State check must come BEFORE Lifecycle check because some entities might match both patterns (e.g., "MenuStateLifecycle" -- unlikely but defensive). If an entity ends with "State", classify as State.

    2. Update the system reclassification in tab_cels_draw():
       - After classify_all_entities(), reclassify ENTITY_CLASS_SYSTEM nodes as ENTITY_CLASS_ENTITY (as established in Plan 01). This ensures no Systems section appears in the CELS tab tree.

    3. Add change highlighting for State entities:
       - Add to the ecs_state_t (now cels_state_t) struct:
         ```
         char *prev_entity_json;        // serialized previous component values
         char *prev_entity_path;        // which entity the prev_json belongs to
         int64_t flash_expire_ms;       // CLOCK_MONOTONIC ms when flash ends (0 = no flash)
         ```
       - In tab_cels_draw, when rendering the inspector for a State entity:
         a. Check if entity_detail is for the same entity as prev_entity_path
         b. If yes, serialize current component values via yyjson_val_write() and compare with prev_entity_json
         c. If values differ, set flash_expire_ms = now + 2000 (2-second flash)
         d. Update prev_entity_json with current serialization
         e. If now < flash_expire_ms, render the inspector with A_BOLD attribute on changed values
       - For the flash effect: apply A_BOLD | COLOR_PAIR(CP_RECONNECTING) (yellow) to the entire inspector content area when flashing. This is simpler than per-field diffing and provides a clear visual signal.
       - Free prev_entity_json and prev_entity_path in tab_cels_fini.
       - Use CLOCK_MONOTONIC for timestamps (already used elsewhere via now_ms pattern).
       - Do NOT use napms() -- check timestamp in render path only.

    4. The State section inspector shows the same entity detail view as other entities (component values, tags, pairs). No special rendering needed beyond the flash effect. The existing inspector Branch B code handles this.

    5. Ensure the State section starts collapsed (tree_view_init already sets all section_collapsed to true).
  </action>
  <verify>
    Build: `cmake --build build 2>&1 | tail -5`
    State classification exists: `grep "ENTITY_CLASS_STATE" cels-debug/src/tabs/tab_cels.c`
    Flash fields exist: `grep "flash_expire" cels-debug/src/tabs/tab_cels.c`
    Name helper exists: `grep "name_ends_with_state\|name_is_state" cels-debug/src/tabs/tab_cels.c`
  </verify>
  <done>
    CELS tab tree shows 5 sections: Compositions, Entities, Lifecycles, State, Components (C-E-L-S-C).
    State section contains entities whose names end with "State".
    Selecting a State entity shows component values in the inspector.
    When component values change between polls, the inspector flashes bold/yellow for 2 seconds.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build` succeeds with 0 errors
2. CELS tab shows 5 section headers: Compositions, Entities, Lifecycles, State, Components
3. Bold first letters spell C-E-L-S-C vertically
4. State section contains entities with "State" in their name
5. Selecting a State entity shows its component data in the inspector
6. No crashes when expanding/collapsing State section
</verification>

<success_criteria>
- CELS-C acronym is complete: Compositions, Entities, Lifecycles, State, Components
- State entities are correctly classified and visible in the State section
- Change highlighting flash works (bold/yellow for ~2 seconds on value change)
- Build produces 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-state-performance-and-polish/05-02-SUMMARY.md`
</output>
