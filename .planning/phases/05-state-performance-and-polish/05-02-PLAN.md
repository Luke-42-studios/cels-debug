---
phase: 05-state-performance-and-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - cels-debug/src/data_model.h
  - cels-debug/src/tree_view.c
  - cels-debug/src/tabs/tab_cels.c
autonomous: true

must_haves:
  truths:
    - "CELS tab sections spell C-E-L-S-C: Compositions, Entities, Lifecycles, State, Components"
    - "State section shows entities whose names end with 'State' (naming heuristic -- v0.1 limitation, may show 0 items if no State-named entities exist in the running app)"
    - "Selecting a State entity shows its component values in the inspector"
    - "Value changes flash highlighted for ~2 seconds when component data changes between polls"
  artifacts:
    - path: "cels-debug/src/data_model.h"
      provides: "Updated entity_class_t enum with STATE alongside SYSTEM"
      contains: "ENTITY_CLASS_STATE"
    - path: "cels-debug/src/tree_view.c"
      provides: "Updated section_names with State"
      contains: "\"State\""
    - path: "cels-debug/src/tabs/tab_cels.c"
      provides: "State classification heuristic and change highlighting"
      contains: "ENTITY_CLASS_STATE"
  key_links:
    - from: "cels-debug/src/tabs/tab_cels.c"
      to: "data_model.h"
      via: "ENTITY_CLASS_STATE enum value"
      pattern: "ENTITY_CLASS_STATE"
    - from: "cels-debug/src/tree_view.c"
      to: "data_model.h"
      via: "section_names array indexed by entity_class_t"
      pattern: "section_names.*ENTITY_CLASS"
    - from: "cels-debug/src/tabs/tab_systems.c"
      to: "data_model.h"
      via: "ENTITY_CLASS_SYSTEM enum value for system classification"
      pattern: "ENTITY_CLASS_SYSTEM"
---

<objective>
Add the State section to the CELS tab as the "S" in the CELS-C acronym, replacing the removed Systems enum value. State entities are identified by a naming heuristic (names ending with "State"). The inspector shows component values with change highlighting (2-second flash on value change).

Purpose: Completes the CELS-C paradigm in the CELS tab. State is the user-visible representation of CELS state entities, providing insight into lifecycle and state-related entities in the running application.

Output: Updated entity_class_t enum, updated section_names in tree_view.c, State classification heuristic in tab_cels.c, change-highlighting flash in the inspector.

Note: The State section uses a name_ends_with_state heuristic for entity classification. This is a v0.1 limitation -- CEL_State values are C-level static variables (not Flecs components), so they are not directly visible via the REST API. The State section shows entities whose names match the CEL_State naming convention, which may show 0 items in apps that don't follow this pattern.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@tools/cels-debug/.planning/PROJECT.md
@tools/cels-debug/.planning/ROADMAP.md
@tools/cels-debug/.planning/phases/05-state-performance-and-polish/05-CONTEXT.md
@tools/cels-debug/.planning/phases/05-state-performance-and-polish/05-RESEARCH.md
@tools/cels-debug/.planning/phases/05-state-performance-and-polish/05-01-SUMMARY.md

Key source files:
@tools/cels-debug/src/data_model.h
@tools/cels-debug/src/tree_view.c
@tools/cels-debug/src/tree_view.h
@tools/cels-debug/src/tabs/tab_cels.c
@tools/cels-debug/src/tabs/tab_cels.h
@tools/cels-debug/src/tabs/tab_systems.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update entity_class_t enum and section names</name>
  <files>
    cels-debug/src/data_model.h
    cels-debug/src/tree_view.c
  </files>
  <action>
    1. In data_model.h, update the entity_class_t enum to include both STATE and SYSTEM:
       - ENTITY_CLASS_COMPOSITION = 0  (C)
       - ENTITY_CLASS_ENTITY = 1       (E)
       - ENTITY_CLASS_LIFECYCLE = 2    (L)
       - ENTITY_CLASS_STATE = 3        (S) -- NEW
       - ENTITY_CLASS_COMPONENT = 4    (C)
       - ENTITY_CLASS_SYSTEM = 5       (retained for tab_systems.c classification)
       - ENTITY_CLASS_COUNT = 6
       - Update the comment to: "Entity classification -- sections 0-4 spell CELS-C, index 5 is internal (Systems tab)"

    2. In tree_view.c, update the section_names array to size 6:
       [ENTITY_CLASS_COMPOSITION] = "Compositions"
       [ENTITY_CLASS_ENTITY] = "Entities"
       [ENTITY_CLASS_LIFECYCLE] = "Lifecycles"
       [ENTITY_CLASS_STATE] = "State"
       [ENTITY_CLASS_COMPONENT] = "Components"
       [ENTITY_CLASS_SYSTEM] = "Systems"

    3. In tree_view.c, the ENTITY_CLASS_SYSTEM special-case code (phase sub-headers in rebuild, system-specific rendering) should remain. The CELS tab's tree_view never has ENTITY_CLASS_SYSTEM items (Plan 01 reclassifies them), so this code path is never hit in the CELS tab. But tab_systems might reference tree_view utilities later.

    4. In tree_view.c, update any code referencing ENTITY_CLASS_SYSTEM by enum value to use the new position (5). Since the enum is symbolic, this should be automatic -- but verify that no hardcoded numeric indices are used.

    5. Verify tab_systems.c (from Plan 01) still compiles: it references ENTITY_CLASS_SYSTEM which is now at index 5 instead of 3. Since it uses the symbolic name, this should work without changes. Verify with: `grep "ENTITY_CLASS_SYSTEM" cels-debug/src/tabs/tab_systems.c` to confirm symbolic usage.
  </action>
  <verify>
    Build succeeds: `cmake --build build 2>&1 | tail -5`
    Enum has STATE: `grep "ENTITY_CLASS_STATE" cels-debug/src/data_model.h`
    Enum retains SYSTEM: `grep "ENTITY_CLASS_SYSTEM" cels-debug/src/data_model.h`
    Section names updated: `grep '"State"' cels-debug/src/tree_view.c`
    tab_systems.c compatibility: `grep "ENTITY_CLASS_SYSTEM" cels-debug/src/tabs/tab_systems.c` -- should show symbolic usage (not hardcoded "3" or "5")
  </verify>
  <done>
    entity_class_t enum has ENTITY_CLASS_STATE at position 3, spelling C-E-L-S-C for sections 0-4.
    ENTITY_CLASS_SYSTEM retained at position 5 for tab_systems.c compatibility.
    tree_view.c section_names includes "State" at the correct index.
    Build compiles with 0 errors, including tab_systems.c.
  </done>
</task>

<task type="auto">
  <name>Task 2: State classification and change highlighting in CELS tab</name>
  <files>
    cels-debug/src/tabs/tab_cels.c
  </files>
  <action>
    1. Add State classification in tab_cels.c's classify_node() function:
       - Create helper: `static bool name_ends_with_state(entity_node_t *node)` -- checks if node->name ends with "State" (case-sensitive, similar pattern to name_is_lifecycle).
       - Add classification rule with this priority order in classify_node:
         1. Systems -> ENTITY_CLASS_SYSTEM (reclassified to ENTITY_CLASS_ENTITY in draw)
         2. Components -> ENTITY_CLASS_COMPONENT
         3. State -> ENTITY_CLASS_STATE (NEW -- check name_ends_with_state)
         4. Lifecycles -> ENTITY_CLASS_LIFECYCLE
         5. Leaf entities -> ENTITY_CLASS_ENTITY
         6. Parent entities -> ENTITY_CLASS_COMPOSITION
       - State check must come BEFORE Lifecycle check to prevent overlap.

    2. Update the system reclassification in tab_cels_draw():
       - After classify_all_entities(), reclassify ENTITY_CLASS_SYSTEM nodes as ENTITY_CLASS_ENTITY (as established in Plan 01). This ensures no Systems section appears in the CELS tab tree.

    3. Add change highlighting for State entities:
       - Add to the cels_state_t struct:
         ```
         char *prev_entity_json;        // serialized previous component values
         char *prev_entity_path;        // which entity the prev_json belongs to
         int64_t flash_expire_ms;       // CLOCK_MONOTONIC ms when flash ends (0 = no flash)
         ```
       - In tab_cels_draw, when rendering the inspector for a State entity:
         a. Check if entity_detail is for the same entity as prev_entity_path
         b. If yes, serialize current component values via yyjson_val_write() and compare with prev_entity_json
         c. If values differ, set flash_expire_ms = now + 2000 (2-second flash)
         d. Update prev_entity_json with current serialization
         e. If now < flash_expire_ms, render the inspector with A_BOLD | COLOR_PAIR(CP_RECONNECTING) (yellow) on the entire inspector content area
       - For the flash effect: apply A_BOLD attribute to the entire inspector content area when flashing. This is simpler than per-field diffing.
       - Free prev_entity_json and prev_entity_path in tab_cels_fini.
       - Use CLOCK_MONOTONIC for timestamps (already used elsewhere via now_ms pattern).
       - Do NOT use napms() -- check timestamp in render path only.

    4. The State section inspector shows the same entity detail view as other entities (component values, tags, pairs). No special rendering needed beyond the flash effect.

    5. Ensure the State section starts collapsed (tree_view_init already sets all section_collapsed to true).
  </action>
  <verify>
    Build: `cmake --build build 2>&1 | tail -5`
    State classification exists: `grep "ENTITY_CLASS_STATE" cels-debug/src/tabs/tab_cels.c`
    Flash fields exist: `grep "flash_expire" cels-debug/src/tabs/tab_cels.c`
    Name helper exists: `grep "name_ends_with_state\|name_is_state" cels-debug/src/tabs/tab_cels.c`
  </verify>
  <done>
    CELS tab tree shows 5 sections: Compositions, Entities, Lifecycles, State, Components (C-E-L-S-C).
    State section contains entities whose names end with "State" (naming heuristic, v0.1 limitation).
    Selecting a State entity shows component values in the inspector.
    When component values change between polls, the inspector flashes bold/yellow for 2 seconds.
  </done>
</task>

</tasks>

<verification>
1. `cmake --build build` succeeds with 0 errors
2. CELS tab shows 5 section headers: Compositions, Entities, Lifecycles, State, Components
3. Bold first letters spell C-E-L-S-C vertically
4. State section contains entities with "State" suffix in their name (may be 0 items depending on running app)
5. Selecting a State entity shows its component data in the inspector
6. tab_systems.c still compiles and works (ENTITY_CLASS_SYSTEM at index 5 via symbolic name)
7. No crashes when expanding/collapsing State section
</verification>

<success_criteria>
- CELS-C acronym is complete: Compositions, Entities, Lifecycles, State, Components
- State entities are correctly classified using name_ends_with_state heuristic
- Change highlighting flash works (bold/yellow for ~2 seconds on value change)
- ENTITY_CLASS_SYSTEM retained for tab_systems.c compatibility (no breakage)
- Build produces 0 errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-state-performance-and-polish/05-02-SUMMARY.md`
</output>
