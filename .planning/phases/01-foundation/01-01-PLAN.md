---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/cachy/workspaces/libs/cels/CMakeLists.txt
  - /home/cachy/workspaces/libs/cels/src/cels.cpp
  - /home/cachy/workspaces/libs/cels/tools/cels-debug/CMakeLists.txt
  - /home/cachy/workspaces/libs/cels/tools/cels-debug/src/main.c
autonomous: true

must_haves:
  truths:
    - "cmake -DCELS_BUILD_TOOLS=ON -DCELS_DEBUG=ON configures without errors"
    - "cels-debug executable builds and runs (prints version, exits 0)"
    - "CELS library compiles with CELS_DEBUG defined and FlecsStats imported"
    - "ncursesw, libcurl, and yyjson are all linked into the cels-debug binary"
  artifacts:
    - path: "tools/cels-debug/CMakeLists.txt"
      provides: "Build configuration for cels-debug tool"
      contains: "FetchContent_Declare"
    - path: "tools/cels-debug/src/main.c"
      provides: "Minimal entry point for build verification"
      contains: "main"
    - path: "CMakeLists.txt"
      provides: "CELS_BUILD_TOOLS and CELS_DEBUG options"
      contains: "CELS_BUILD_TOOLS"
    - path: "src/cels.cpp"
      provides: "FlecsStats import behind CELS_DEBUG"
      contains: "FlecsStats"
  key_links:
    - from: "CMakeLists.txt"
      to: "tools/cels-debug/CMakeLists.txt"
      via: "add_subdirectory(tools/cels-debug)"
      pattern: "add_subdirectory.*cels-debug"
    - from: "CMakeLists.txt"
      to: "cels target"
      via: "target_compile_definitions(cels PRIVATE CELS_DEBUG)"
      pattern: "CELS_DEBUG"
    - from: "src/cels.cpp"
      to: "FlecsStats module"
      via: "ECS_IMPORT guarded by #ifdef CELS_DEBUG"
      pattern: "ifdef CELS_DEBUG"
---

<objective>
Build system and FlecsStats prerequisite: CMake project builds cels-debug with all dependencies, and CELS runtime imports FlecsStats behind #ifdef CELS_DEBUG.

Purpose: Without a working build, nothing else can happen. Without FlecsStats, the /stats/world endpoint crashes the target app. This plan establishes both foundations.
Output: Buildable cels-debug binary, CELS_DEBUG and CELS_BUILD_TOOLS cmake options, FlecsStats import in CELS runtime.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/cachy/workspaces/libs/cels/tools/cels-debug/.planning/PROJECT.md
@/home/cachy/workspaces/libs/cels/tools/cels-debug/.planning/ROADMAP.md
@/home/cachy/workspaces/libs/cels/tools/cels-debug/.planning/phases/01-foundation/RESEARCH.md
@/home/cachy/workspaces/libs/cels/CMakeLists.txt
@/home/cachy/workspaces/libs/cels/src/cels.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CELS_DEBUG option and FlecsStats import to CELS runtime</name>
  <files>
    /home/cachy/workspaces/libs/cels/CMakeLists.txt
    /home/cachy/workspaces/libs/cels/src/cels.cpp
  </files>
  <action>
  Two changes to the parent CELS project:

  **1. CMakeLists.txt** -- Add CELS_DEBUG option AFTER the library target section (after the `add_library(cels::cels ALIAS cels)` line, before the Test Targets section). Add:

  ```cmake
  # ============================================================================
  # Debug Options
  # ============================================================================
  option(CELS_DEBUG "Enable debug features (FlecsStats import for REST stats endpoints)" OFF)
  if(CELS_DEBUG)
      target_compile_definitions(cels PRIVATE CELS_DEBUG)
  endif()
  ```

  **2. src/cels.cpp** -- Add FlecsStats import inside `cels_init()`, AFTER the EcsRest configuration block (after line 514, the `ecs_set_id(...)` call) and BEFORE the lifecycle system setup (the `ecs_system_desc_t lifecycle_sys_desc = {};` line). Insert:

  ```cpp
  #ifdef CELS_DEBUG
          // Import FlecsStats module for debug tooling
          // Required for /stats/world and /stats/pipeline REST endpoints
          // Without this, /stats/* endpoints cause a NULL dereference crash
          ECS_IMPORT(g_context->ecs.c_ptr(), FlecsStats);
  #endif
  ```

  Note: The indentation is 8 spaces (matching the surrounding code inside the if block).
  Note: `ECS_IMPORT` is a C macro that works with raw `ecs_world_t*` -- the `c_ptr()` call is correct here.
  </action>
  <verify>
  Build CELS with debug enabled and verify it compiles:
  ```bash
  cd /home/cachy/workspaces/libs/cels/build
  cmake .. -DCELS_DEBUG=ON
  cmake --build . --target cels 2>&1 | tail -5
  ```
  Expected: Build succeeds with no errors. Verify the define is active:
  ```bash
  grep -r "CELS_DEBUG" /home/cachy/workspaces/libs/cels/build/CMakeCache.txt
  ```
  </verify>
  <done>CELS library builds with -DCELS_DEBUG=ON. FlecsStats import is present in cels.cpp behind #ifdef CELS_DEBUG. The CELS_DEBUG option defaults to OFF (no impact on existing builds).</done>
</task>

<task type="auto">
  <name>Task 2: Create cels-debug CMake project with dependencies and minimal main.c</name>
  <files>
    /home/cachy/workspaces/libs/cels/tools/cels-debug/CMakeLists.txt
    /home/cachy/workspaces/libs/cels/tools/cels-debug/src/main.c
    /home/cachy/workspaces/libs/cels/CMakeLists.txt
  </files>
  <action>
  Three files to create/modify:

  **1. Create `tools/cels-debug/CMakeLists.txt`:**

  ```cmake
  # CELS Debug TUI - Terminal-based ECS inspector
  cmake_minimum_required(VERSION 3.21)
  project(cels-debug VERSION 0.1.0 LANGUAGES C)

  # === Dependencies ===
  include(FetchContent)

  # yyjson - Fast JSON parser (FetchContent, consistent with CELS flecs pattern)
  FetchContent_Declare(
      yyjson
      GIT_REPOSITORY https://github.com/ibireme/yyjson.git
      GIT_TAG        0.12.0
  )
  FetchContent_MakeAvailable(yyjson)

  # ncursesw - TUI rendering (system package, wide-char for UTF-8)
  set(CURSES_NEED_WIDE TRUE)
  set(CURSES_NEED_NCURSES TRUE)
  find_package(Curses REQUIRED)

  # libcurl - HTTP client (system package)
  find_package(CURL REQUIRED)

  # === Executable ===
  add_executable(cels-debug
      src/main.c
  )

  set_target_properties(cels-debug PROPERTIES
      C_STANDARD 99
      C_STANDARD_REQUIRED ON
      C_EXTENSIONS OFF
  )

  target_include_directories(cels-debug PRIVATE
      ${CURSES_INCLUDE_DIRS}
  )

  target_link_libraries(cels-debug PRIVATE
      ${CURSES_LIBRARIES}
      CURL::libcurl
      yyjson
  )
  ```

  **2. Create `tools/cels-debug/src/main.c`:**

  A minimal entry point that verifies all three dependencies can be included and linked. This is NOT the final main.c -- it will be replaced in Plan 01-03. Its purpose is build verification only.

  ```c
  /*
   * cels-debug -- Terminal-based ECS inspector for CELS applications
   * Build verification entry point (replaced in Plan 01-03)
   */
  #include <stdio.h>
  #include <ncurses.h>
  #include <curl/curl.h>
  #include <yyjson.h>

  int main(int argc, char *argv[]) {
      (void)argc;
      (void)argv;

      printf("cels-debug v0.1.0\n");
      printf("  ncurses: %s\n", curses_version());
      printf("  libcurl: %s\n", curl_version());
      printf("  yyjson:  %u.%u.%u\n",
             YYJSON_VERSION_MAJOR,
             YYJSON_VERSION_MINOR,
             YYJSON_VERSION_PATCH);

      return 0;
  }
  ```

  **3. Append to parent CMakeLists.txt** (`/home/cachy/workspaces/libs/cels/CMakeLists.txt`):

  Add a new section at the VERY END of the file (after the Backend Targets section):

  ```cmake
  # ============================================================================
  # Tools
  # ============================================================================
  option(CELS_BUILD_TOOLS "Build CELS development tools (cels-debug)" OFF)
  if(CELS_BUILD_TOOLS)
      add_subdirectory(tools/cels-debug)
  endif()
  ```
  </action>
  <verify>
  Build from scratch with tools enabled:
  ```bash
  cd /home/cachy/workspaces/libs/cels/build
  cmake .. -DCELS_BUILD_TOOLS=ON -DCELS_DEBUG=ON
  cmake --build . --target cels-debug 2>&1 | tail -10
  ```
  Expected: yyjson fetched via FetchContent, ncursesw found, libcurl found, cels-debug binary built.

  Run the binary:
  ```bash
  ./cels-debug
  ```
  Expected output (versions may vary):
  ```
  cels-debug v0.1.0
    ncurses: ncurses 6.5.20241228
    libcurl: libcurl/8.x.x ...
    yyjson:  0.12.0
  ```
  Exit code 0.
  </verify>
  <done>cels-debug executable builds and runs, printing library versions. All three dependencies (ncursesw, libcurl, yyjson) are resolved and linked. CELS_BUILD_TOOLS option defaults to OFF. The tools/ subdirectory is wired into the parent CMake build.</done>
</task>

</tasks>

<verification>
Full build verification from clean state:
```bash
cd /home/cachy/workspaces/libs/cels/build
cmake .. -DCELS_BUILD_TOOLS=ON -DCELS_DEBUG=ON
cmake --build . 2>&1 | tail -20
./cels-debug
```

1. No CMake configuration errors
2. No build errors or warnings in cels-debug target
3. No build errors in cels target with CELS_DEBUG=ON
4. cels-debug prints version info and exits 0
5. Existing tests still pass: `ctest --test-dir /home/cachy/workspaces/libs/cels/build`
</verification>

<success_criteria>
- cmake configures with -DCELS_BUILD_TOOLS=ON -DCELS_DEBUG=ON without errors
- cels-debug binary builds and runs, printing ncurses/curl/yyjson versions
- CELS library builds with FlecsStats import when CELS_DEBUG=ON
- Default builds (no flags) are unaffected -- both options default OFF
- Existing CELS tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
