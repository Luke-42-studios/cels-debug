---
phase: 03-entities-and-components
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - tools/cels-debug/src/tabs/tab_entities.h
  - tools/cels-debug/src/tabs/tab_entities.c
  - tools/cels-debug/src/tab_system.c
  - tools/cels-debug/CMakeLists.txt
autonomous: true

must_haves:
  truths:
    - "User sees a scrollable entity tree in the left panel of the Entities tab"
    - "Selecting an entity shows its component names and values in the right panel"
    - "j/k or arrow keys scroll the entity list, left/right arrows switch panel focus"
    - "Enter toggles expand/collapse on tree nodes with children"
    - "f key toggles visibility of anonymous entities"
    - "Component inspector updates as cursor moves through entity list"
    - "Component groups are collapsible with Enter in the right panel"
  artifacts:
    - path: "tools/cels-debug/src/tabs/tab_entities.h"
      provides: "tab_entities_init/fini/draw/input declarations"
      contains: "tab_entities_init"
    - path: "tools/cels-debug/src/tabs/tab_entities.c"
      provides: "Full Entities tab implementation with split panel, tree, and inspector"
      min_lines: 200
    - path: "tools/cels-debug/src/tab_system.c"
      provides: "Entities tab wired into tab_defs array"
      contains: "tab_entities_init"
  key_links:
    - from: "tools/cels-debug/src/tabs/tab_entities.c"
      to: "app_state.entity_list"
      via: "tree_view_rebuild_visible called with entity_list from app_state"
      pattern: "entity_list"
    - from: "tools/cels-debug/src/tabs/tab_entities.c"
      to: "app_state.entity_detail"
      via: "json_render_component renders entity_detail->components"
      pattern: "entity_detail"
    - from: "tools/cels-debug/src/tabs/tab_entities.c"
      to: "app_state.selected_entity_path"
      via: "sets path when cursor moves to trigger detail polling"
      pattern: "selected_entity_path"
    - from: "tools/cels-debug/src/tab_system.c"
      to: "tab_entities_init"
      via: "tab_defs[1] vtable entry"
      pattern: "tab_entities"
---

<objective>
Implement the Entities tab: a split-panel view with an interactive entity tree (left) and component inspector (right).

Purpose: This is the core debugging value of Phase 03. Users browse all entities in the running ECS world, navigate the parent-child hierarchy, and inspect component values in real time.
Output: Working Entities tab replacing the placeholder, wired into the tab system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@tools/cels-debug/.planning/PROJECT.md
@tools/cels-debug/.planning/phases/03-entities-and-components/03-CONTEXT.md
@tools/cels-debug/.planning/phases/03-entities-and-components/03-RESEARCH.md
@tools/cels-debug/.planning/phases/03-entities-and-components/03-01-SUMMARY.md
@tools/cels-debug/.planning/phases/03-entities-and-components/03-02-SUMMARY.md

@tools/cels-debug/src/tui.h
@tools/cels-debug/src/tab_system.h
@tools/cels-debug/src/tab_system.c
@tools/cels-debug/src/data_model.h
@tools/cels-debug/src/split_panel.h
@tools/cels-debug/src/scroll.h
@tools/cels-debug/src/tree_view.h
@tools/cels-debug/src/json_render.h
@tools/cels-debug/src/tabs/tab_overview.h
@tools/cels-debug/src/tabs/tab_overview.c
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement the Entities tab</name>
  <files>
    tools/cels-debug/src/tabs/tab_entities.h
    tools/cels-debug/src/tabs/tab_entities.c
  </files>
  <action>
  **tab_entities.h** -- Follow the same pattern as tab_overview.h:
  ```c
  #ifndef CELS_DEBUG_TAB_ENTITIES_H
  #define CELS_DEBUG_TAB_ENTITIES_H
  #include "../tab_system.h"
  void tab_entities_init(tab_t *self);
  void tab_entities_fini(tab_t *self);
  void tab_entities_draw(const tab_t *self, WINDOW *win, const void *app_state);
  bool tab_entities_input(tab_t *self, int ch, void *app_state);
  #endif
  ```

  **tab_entities.c** -- Full implementation:

  Per-tab private state struct:
  ```c
  typedef struct entities_state {
      split_panel_t panel;         /* Left/right split */
      tree_view_t tree;            /* Entity tree + virtual scrolling */
      scroll_state_t inspector_scroll; /* Scroll state for component inspector */
      bool *comp_expanded;         /* Expand/collapse state per component group */
      int comp_expanded_count;     /* Number of component groups allocated */
      uint64_t last_entity_list_id; /* Track whether entity_list changed (compare pointer or count) */
      bool panel_created;          /* Whether split_panel windows exist */
  } entities_state_t;
  ```

  **tab_entities_init:**
  1. Allocate entities_state_t, store in self->state.
  2. Call tree_view_init(&es->tree).
  3. Call scroll_reset(&es->inspector_scroll).
  4. Set panel_created = false (defer window creation to first draw, since we don't know dimensions at init time).

  **tab_entities_fini:**
  1. If panel_created, call split_panel_destroy(&es->panel).
  2. Call tree_view_fini(&es->tree).
  3. Free comp_expanded array.
  4. Free the entities_state_t.

  **tab_entities_draw:**
  1. Cast app_state to app_state_t*.
  2. Get content window dimensions: `int h = getmaxy(win); int w = getmaxx(win);`
  3. If !panel_created, call `split_panel_create(&es->panel, h, w, getbegy(win));` and set panel_created=true.
  4. Check if panel dimensions changed (terminal resize). If h or w differ from panel.height or panel.left_width+panel.right_width, call `split_panel_resize(&es->panel, h, w, getbegy(win));`
  5. Erase both panel windows: `werase(es->panel.left); werase(es->panel.right);`
  6. Draw panel borders with titles: `split_panel_draw_borders(&es->panel, "Entities", "Inspector");`

  **Left panel (entity tree):**
  7. If state->entity_list is not NULL:
     - Call `tree_view_rebuild_visible(&es->tree, state->entity_list);` on EVERY draw call (entity data may have been replaced by a new poll). This is O(n) but fast.
     - Call `tree_view_render(&es->tree, es->panel.left);` to render the visible tree rows inside the left panel border.
  8. If entity_list is NULL, center "Waiting for data..." in the left panel.

  **Right panel (component inspector):**
  9. Get the currently selected entity: `entity_node_t *sel = tree_view_selected(&es->tree);`
  10. If sel is not NULL and state->entity_detail is not NULL:
      - Check if entity_detail matches the selected entity (compare path or id).
      - If match, render component groups:
        a. Iterate over entity_detail->components (yyjson_obj_foreach).
        b. For each component, use json_render_component() to render the header and (if expanded) the value tree.
        c. Also render tags from entity_detail->tags (if present) as a "Tags" group.
        d. Also render pairs from entity_detail->pairs (if present) as a "Pairs" group.
        e. Apply inspector_scroll for virtual scrolling of the component list.
      - If no match (detail is for a different entity, still loading), show "Loading..." centered.
  11. If no entity selected, show "Select an entity" centered in right panel.
  12. Call split_panel_refresh(&es->panel) to wnoutrefresh both windows.

  IMPORTANT: The tab draws into its OWN windows (es->panel.left and es->panel.right), NOT into the passed `win`. The passed `win` (win_content) is used only for dimension/position info. Do NOT call wnoutrefresh on `win` -- the tab's own windows handle their own refresh.

  **tab_entities_input:**
  1. Cast app_state to app_state_t*.
  2. Check focus switching first: `if (split_panel_handle_focus(&es->panel, ch)) return true;`
  3. If left panel focused (es->panel.focus == 0):
     - KEY_UP or 'k': `scroll_move(&es->tree.scroll, -1);` then update selected_entity_path.
     - KEY_DOWN or 'j': `scroll_move(&es->tree.scroll, +1);` then update selected_entity_path.
     - KEY_PPAGE: `scroll_page(&es->tree.scroll, -1);` then update selected_entity_path.
     - KEY_NPAGE: `scroll_page(&es->tree.scroll, +1);` then update selected_entity_path.
     - 'g': `scroll_to_top(&es->tree.scroll);` then update selected_entity_path.
     - 'G': `scroll_to_bottom(&es->tree.scroll);` then update selected_entity_path.
     - Enter (KEY_ENTER or '\n' or '\r'): `tree_view_toggle_expand(&es->tree, state->entity_list);`
     - 'f': `tree_view_toggle_anonymous(&es->tree, state->entity_list);`

     After any navigation key in left panel, update selected_entity_path:
     ```c
     entity_node_t *sel = tree_view_selected(&es->tree);
     free(state->selected_entity_path);
     state->selected_entity_path = sel ? strdup(sel->full_path) : NULL;
     /* Clear stale detail if entity changed */
     if (state->entity_detail && sel &&
         strcmp(state->entity_detail->path, sel->full_path) != 0) {
         entity_detail_free(state->entity_detail);
         state->entity_detail = NULL;
     }
     ```
     Return true for handled keys.

  4. If right panel focused (es->panel.focus == 1):
     - KEY_UP or 'k': `scroll_move(&es->inspector_scroll, -1);`
     - KEY_DOWN or 'j': `scroll_move(&es->inspector_scroll, +1);`
     - Enter: toggle expand/collapse on the component group at cursor position. Need to track which row corresponds to which component header. Use the comp_expanded array.
     Return true for handled keys.

  5. Return false for unhandled keys.

  **Updating selected_entity_path on first display:**
  On the first draw where entity_list becomes available and no entity is selected yet, auto-select the first entity: set selected_entity_path to the first visible node's full_path. This triggers detail polling on the next cycle.

  IMPORTANT: strdup and free are used for selected_entity_path. Include `<string.h>` and `<stdlib.h>`.
  </action>
  <verify>
  Build compiles: `cd /home/cachy/workspaces/libs/cels/tools/cels-debug && cmake --build build 2>&1 | tail -10`
  </verify>
  <done>tab_entities.h/c implement the full Entities tab with split panel, interactive entity tree (left) with expand/collapse and anonymous toggle, and component inspector (right) with collapsible component groups and recursive JSON rendering.</done>
</task>

<task type="auto">
  <name>Task 2: Wire Entities tab into tab system and build</name>
  <files>
    tools/cels-debug/src/tab_system.c
    tools/cels-debug/CMakeLists.txt
  </files>
  <action>
  **tab_system.c changes:**
  1. Add include at the top: `#include "tabs/tab_entities.h"`
  2. In the tab_defs array, replace the "Entities" entry (index 1) from placeholder to real implementation:
     ```c
     { "Entities",     ENDPOINT_QUERY | ENDPOINT_ENTITY,
       tab_entities_init, tab_entities_fini,
       tab_entities_draw, tab_entities_input },
     ```
     Note: ENDPOINT_ENTITY was added in Plan 03-01 (Task 3). The bitmask needs both ENDPOINT_QUERY (for entity list) and ENDPOINT_ENTITY (for selected entity detail).

  **CMakeLists.txt changes:**
  Add `src/tabs/tab_entities.c` to the add_executable source list, after the existing tab files.

  Verify the full source list in add_executable includes:
  - src/main.c, src/http_client.c, src/json_parser.c, src/data_model.c
  - src/tui.c, src/tab_system.c
  - src/scroll.c, src/split_panel.c, src/json_render.c, src/tree_view.c (from Plan 02)
  - src/tabs/tab_placeholder.c, src/tabs/tab_overview.c
  - src/tabs/tab_entities.c (NEW)
  </action>
  <verify>
  Build compiles: `cd /home/cachy/workspaces/libs/cels/tools/cels-debug && cmake -B build -DCMAKE_BUILD_TYPE=Debug && cmake --build build 2>&1 | tail -10`
  Verify tab_entities is wired: `grep 'tab_entities' src/tab_system.c` shows the vtable entry.
  Verify CMake includes the file: `grep 'tab_entities' CMakeLists.txt` shows the source file.
  </verify>
  <done>Entities tab replaces placeholder in tab_defs. Binary compiles and links. Switching to tab 2 (Entities) shows the split panel with entity tree instead of "Not implemented yet".</done>
</task>

</tasks>

<verification>
1. `cmake --build build` succeeds
2. Tab 2 shows split panel with "Entities" and "Inspector" titled borders
3. When connected to a running CELS app, entity tree populates in left panel
4. j/k scrolls the entity list, left/right switches panel focus
5. Enter toggles tree expand/collapse on nodes with children
6. f toggles anonymous entity visibility
7. Selecting an entity shows component values in right panel
8. Component groups in inspector are collapsible with Enter
</verification>

<success_criteria>
The Entities tab is fully interactive: users can browse entities in a tree view, navigate with keyboard, expand/collapse nodes, toggle anonymous entities, and inspect component values for the selected entity. Data updates live on each poll cycle.
</success_criteria>

<output>
After completion, create `.planning/phases/03-entities-and-components/03-03-SUMMARY.md`
</output>
